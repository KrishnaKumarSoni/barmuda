<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#cc5500">
    <title>Admin Dashboard - Barmuda</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#cc5500'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Chart.js with Date Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-effect { backdrop-filter: blur(12px); background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.2); }
        .metric-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .chart-container { position: relative; height: 300px; }
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .period-button.active { background: #cc5500; color: white; }
        .trend-positive { color: #10b981; }
        .trend-negative { color: #ef4444; }
        .trend-neutral { color: #6b7280; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">
    
    <!-- Header -->
    <div class="sticky top-0 z-40 glass-effect border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-brand to-orange-600 rounded-xl flex items-center justify-center">
                            <i class="ph ph-chart-line-up text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">Admin Dashboard</h1>
                            <p class="text-sm text-gray-500">Real-time analytics & insights</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 px-3 py-1.5 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span>Live</span>
                        <span id="last-updated" class="text-green-600">--</span>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="refreshDashboard()" class="inline-flex items-center px-4 py-2 bg-white/80 hover:bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:text-gray-900 transition-all duration-200">
                        <i class="ph ph-arrow-clockwise mr-2 h-4 w-4"></i>
                        Refresh
                    </button>
                    <button onclick="logout()" class="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="ph ph-sign-out h-5 w-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        
        <!-- Time Period Filter -->
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center space-x-2">
                <span class="text-sm font-medium text-gray-700">Time Period:</span>
                <div class="flex bg-white rounded-lg p-1 shadow-sm border border-gray-200">
                    <button onclick="changePeriod('L7D')" class="period-button px-3 py-1.5 text-sm font-medium rounded-md transition-all duration-200" data-period="L7D">7D</button>
                    <button onclick="changePeriod('L30D')" class="period-button active px-3 py-1.5 text-sm font-medium rounded-md transition-all duration-200" data-period="L30D">30D</button>
                    <button onclick="changePeriod('L90D')" class="period-button px-3 py-1.5 text-sm font-medium rounded-md transition-all duration-200" data-period="L90D">90D</button>
                    <button onclick="changePeriod('L6M')" class="period-button px-3 py-1.5 text-sm font-medium rounded-md transition-all duration-200" data-period="L6M">6M</button>
                    <button onclick="changePeriod('L12M')" class="period-button px-3 py-1.5 text-sm font-medium rounded-md transition-all duration-200" data-period="L12M">12M</button>
                </div>
            </div>
            <div class="flex items-center space-x-4 text-sm text-gray-600">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                    <span>Users</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <span>Forms</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                    <span>Conversations</span>
                </div>
            </div>
        </div>

        <!-- Key Metrics Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Total Users -->
            <div class="metric-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">Total Users</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-users-metric">--</p>
                        <p class="text-sm mt-2">
                            <span id="users-trend" class="trend-neutral">--</span>
                            <span class="text-gray-500 ml-1">vs previous period</span>
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="ph ph-users text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Total Forms -->
            <div class="metric-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">Total Forms</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-forms-metric">--</p>
                        <p class="text-sm mt-2">
                            <span id="forms-trend" class="trend-neutral">--</span>
                            <span class="text-gray-500 ml-1">vs previous period</span>
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="ph ph-files text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Total Conversations -->
            <div class="metric-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">Conversations</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-conversations-metric">--</p>
                        <p class="text-sm mt-2">
                            <span id="conversations-trend" class="trend-neutral">--</span>
                            <span class="text-gray-500 ml-1">vs previous period</span>
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                        <i class="ph ph-chat-circle text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Monthly Revenue -->
            <div class="metric-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">Monthly Revenue</p>
                        <p class="text-2xl font-bold text-gray-900">$<span id="mrr-metric">--</span></p>
                        <p class="text-sm mt-2">
                            <span id="mrr-trend" class="trend-neutral">--</span>
                            <span class="text-gray-500 ml-1">growth rate</span>
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center">
                        <i class="ph ph-currency-dollar text-emerald-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Charts -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
            <!-- Growth Trends Chart -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-semibold text-gray-900">Growth Trends</h2>
                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                        <i class="ph ph-chart-line h-4 w-4"></i>
                        <span>Daily Activity</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="trends-chart"></canvas>
                </div>
            </div>

            <!-- Cumulative Growth Chart -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-semibold text-gray-900">Cumulative Growth</h2>
                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                        <i class="ph ph-trend-up h-4 w-4"></i>
                        <span>Total Count</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="cumulative-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Business Analytics Section -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
            <!-- Conversion Funnel -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-semibold text-gray-900">Conversion Funnel</h2>
                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                        <i class="ph ph-funnel h-4 w-4"></i>
                        <span>User Journey</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="funnel-chart"></canvas>
                </div>
                <div class="mt-4 grid grid-cols-4 gap-4 text-center">
                    <div class="bg-blue-50 rounded-lg p-3">
                        <div class="text-lg font-bold text-blue-600" id="funnel-visitors">--</div>
                        <div class="text-xs text-gray-600">Visitors</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-3">
                        <div class="text-lg font-bold text-green-600" id="funnel-signups">--</div>
                        <div class="text-xs text-gray-600">Signups</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-3">
                        <div class="text-lg font-bold text-purple-600" id="funnel-creators">--</div>
                        <div class="text-xs text-gray-600">Form Creators</div>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-3">
                        <div class="text-lg font-bold text-orange-600" id="funnel-active">--</div>
                        <div class="text-xs text-gray-600">Active Forms</div>
                    </div>
                </div>
            </div>

            <!-- User Engagement Metrics -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-semibold text-gray-900">User Engagement</h2>
                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                        <i class="ph ph-users-three h-4 w-4"></i>
                        <span>Activity Metrics</span>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">Engagement Rate</span>
                        <div class="flex items-center space-x-2">
                            <div class="w-32 bg-gray-200 rounded-full h-2">
                                <div id="engagement-bar" class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <span class="text-sm font-semibold text-gray-900" id="engagement-rate">--%</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="text-xl font-bold text-blue-600" id="avg-conversations-per-user">--</div>
                            <div class="text-sm text-gray-600">Avg Conversations/User</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="text-xl font-bold text-green-600" id="avg-forms-per-user">--</div>
                            <div class="text-sm text-gray-600">Avg Forms/User</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Top Performing Forms</h4>
                        <div class="space-y-2" id="top-forms-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secondary Stats -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Revenue Breakdown -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue Breakdown</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Total Revenue</span>
                        <span class="font-semibold text-gray-900">$<span id="total-revenue">--</span></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Paying Customers</span>
                        <span class="font-semibold text-gray-900" id="paying-customers">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Churn Rate</span>
                        <span class="font-semibold text-red-600" id="churn-rate">--%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Retention Rate</span>
                        <span class="font-semibold text-green-600" id="retention-rate">--%</span>
                    </div>
                </div>
                <div class="mt-6 h-48">
                    <canvas id="revenue-chart"></canvas>
                </div>
            </div>

            <!-- System Health -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">System Health</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">API Response</span>
                        <span class="font-semibold text-gray-900" id="api-avg">-- ms</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Error Rate</span>
                        <span class="font-semibold" id="api-errors">--%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Uptime</span>
                        <span class="font-semibold text-green-600" id="system-uptime">--%</span>
                    </div>
                </div>
                
                <div class="mt-6 space-y-3">
                    <div class="bg-gray-50 rounded-lg p-3">
                        <h5 class="text-xs font-semibold text-gray-900 mb-2">Today's Costs</h5>
                        <div class="flex justify-between text-xs">
                            <span class="text-gray-600">Firebase</span>
                            <span class="font-medium text-green-600">$<span id="firebase-cost">--</span></span>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span class="text-gray-600">OpenAI</span>
                            <span class="font-medium text-green-600">$<span id="openai-cost">--</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">User Management</h3>
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="user-search" 
                           placeholder="Search users..." 
                           class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand/20 focus:border-brand">
                    <button onclick="searchUsers()" class="px-4 py-2 bg-brand text-white rounded-lg text-sm font-medium hover:bg-brand/90 transition-colors">
                        <i class="ph ph-magnifying-glass"></i>
                    </button>
                </div>
                
                <div id="search-results" class="hidden">
                    <div class="overflow-hidden rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Plan</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="search-results-table" class="bg-white divide-y divide-gray-200">
                                <!-- Results populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-4">
                    <h4 class="text-sm font-medium text-gray-900 mb-3">Active Users</h4>
                    <div class="space-y-2" id="active-users-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- User Details Modal -->
    <div id="user-details-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeUserDetails()"></div>
            <div class="inline-block align-bottom bg-white rounded-2xl px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full sm:p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="ph ph-user-circle mr-2 h-6 w-6"></i>
                        User Details
                    </h3>
                    <button onclick="closeUserDetails()" class="text-gray-400 hover:text-gray-500">
                        <i class="ph ph-x h-6 w-6"></i>
                    </button>
                </div>
                <div id="user-details-content" class="space-y-6">
                    <!-- Content populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-40 bg-white/80 backdrop-blur-sm">
        <div class="flex items-center justify-center h-full">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 border-4 border-brand border-t-transparent rounded-full animate-spin"></div>
                <span class="text-gray-700 font-medium">Loading analytics...</span>
            </div>
        </div>
    </div>

    <script>
        let dashboardData = null;
        let trendsData = null;
        let currentPeriod = 'L30D';
        let trendsChart = null;
        let cumulativeChart = null;
        let revenueChart = null;
        let funnelChart = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshDashboard();
            setInterval(refreshDashboard, 600000); // Refresh every 10 minutes
        });

        function showLoading(show = true) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        async function refreshDashboard() {
            try {
                // Fetch dashboard and trends data in parallel
                const [dashboardResponse, trendsResponse] = await Promise.all([
                    fetch('/admin/api/dashboard'),
                    fetch(`/admin/api/trends?period=${currentPeriod}`)
                ]);

                if (!dashboardResponse.ok || !trendsResponse.ok) {
                    throw new Error('Failed to fetch data');
                }

                dashboardData = await dashboardResponse.json();
                trendsData = await trendsResponse.json();

                updateDashboard(dashboardData);
                updateTrendsCharts(trendsData);
                
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error refreshing dashboard:', error);
                showNotification('Failed to load dashboard data', 'error');
            }
        }

        function updateDashboard(data) {
            // Update key metrics
            const revenue = data.revenue || {};
            const usage = data.usage || {};
            const users = data.users || {};
            const health = data.health || {};

            // Revenue metrics
            document.getElementById('mrr-metric').textContent = (revenue.mrr || 0).toFixed(0);
            document.getElementById('total-revenue').textContent = (revenue.total_revenue || 0).toFixed(0);
            document.getElementById('paying-customers').textContent = revenue.paying_customers || '0';
            document.getElementById('churn-rate').textContent = (revenue.churn_rate || 0) + '%';
            document.getElementById('retention-rate').textContent = (revenue.retention_rate || 0) + '%';

            // MRR trend
            const mrrTrend = revenue.mrr_growth || 0;
            const mrrTrendEl = document.getElementById('mrr-trend');
            mrrTrendEl.textContent = (mrrTrend >= 0 ? '+' : '') + mrrTrend.toFixed(1) + '%';
            mrrTrendEl.className = mrrTrend >= 0 ? 'trend-positive' : 'trend-negative';

            // User metrics
            document.getElementById('total-users-metric').textContent = users.total_users || '0';

            // Forms metrics
            document.getElementById('total-forms-metric').textContent = usage.total_forms || '0';

            // Conversations metrics  
            document.getElementById('total-conversations-metric').textContent = usage.total_conversations || '0';

            // System health
            document.getElementById('api-avg').textContent = (health.api_response_time?.avg || 0) + ' ms';
            const errorRate = health.error_rates?.api_errors || 0;
            const errorEl = document.getElementById('api-errors');
            errorEl.textContent = errorRate + '%';
            errorEl.className = errorRate > 5 ? 'font-semibold text-red-600' : 'font-semibold text-green-600';
            
            document.getElementById('system-uptime').textContent = (health.system_uptime || 100) + '%';
            document.getElementById('firebase-cost').textContent = (health.firebase_usage?.estimated_cost || 0).toFixed(2);
            document.getElementById('openai-cost').textContent = (health.openai_usage?.estimated_cost || 0).toFixed(2);

            // Update revenue chart
            updateRevenueChart(revenue);

            // Update active users list
            updateActiveUsersList(users.most_active_users || []);
        }

        function updateTrendsCharts(data) {
            if (!data.daily_data) return;

            const summary = data.summary || {};
            const businessMetrics = data.business_metrics || {};
            
            // Update trend indicators
            updateTrendIndicator('users-trend', summary.user_growth_percent || 0);
            updateTrendIndicator('forms-trend', summary.form_growth_percent || 0);
            updateTrendIndicator('conversations-trend', summary.conversation_growth_percent || 0);

            // Update trend charts
            updateTrendsChart(data.daily_data);
            updateCumulativeChart(data.daily_data);
            
            // Update business analytics
            updateBusinessAnalytics(businessMetrics);
        }

        function updateTrendIndicator(elementId, value) {
            const element = document.getElementById(elementId);
            element.textContent = (value >= 0 ? '+' : '') + value.toFixed(1) + '%';
            element.className = value >= 0 ? 'trend-positive' : value < 0 ? 'trend-negative' : 'trend-neutral';
        }

        function updateTrendsChart(dailyData) {
            const ctx = document.getElementById('trends-chart').getContext('2d');
            
            if (trendsChart) {
                trendsChart.destroy();
            }

            // Create proper date-value pairs for Chart.js
            const userData = dailyData.map(d => ({ x: d.date, y: d.users }));
            const formsData = dailyData.map(d => ({ x: d.date, y: d.forms }));
            const conversationsData = dailyData.map(d => ({ x: d.date, y: d.conversations }));

            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'New Users',
                            data: userData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        },
                        {
                            label: 'New Forms',
                            data: formsData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        },
                        {
                            label: 'New Conversations',
                            data: conversationsData,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 12 },
                            bodyFont: { size: 11 },
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: currentPeriod === 'L7D' ? 'day' : currentPeriod === 'L30D' ? 'day' : currentPeriod === 'L90D' ? 'week' : 'month',
                                displayFormats: {
                                    day: 'MMM dd',
                                    week: 'MMM dd', 
                                    month: 'MMM yyyy'
                                }
                            },
                            grid: { display: false },
                            ticks: {
                                font: { size: 11 },
                                maxTicksLimit: currentPeriod === 'L7D' ? 7 : currentPeriod === 'L30D' ? 8 : 6
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: { size: 11 },
                                precision: 0
                            },
                            title: {
                                display: true,
                                text: 'Daily Count',
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        function updateCumulativeChart(dailyData) {
            const ctx = document.getElementById('cumulative-chart').getContext('2d');
            
            if (cumulativeChart) {
                cumulativeChart.destroy();
            }

            // Create proper date-value pairs for Chart.js
            const cumulativeUserData = dailyData.map(d => ({ x: d.date, y: d.cumulative_users }));
            const cumulativeFormsData = dailyData.map(d => ({ x: d.date, y: d.cumulative_forms }));
            const cumulativeConversationsData = dailyData.map(d => ({ x: d.date, y: d.cumulative_conversations }));

            cumulativeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Total Users',
                            data: cumulativeUserData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.05)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        },
                        {
                            label: 'Total Forms',
                            data: cumulativeFormsData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.05)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        },
                        {
                            label: 'Total Conversations',
                            data: cumulativeConversationsData,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.05)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 12 },
                            bodyFont: { size: 11 },
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: currentPeriod === 'L7D' ? 'day' : currentPeriod === 'L30D' ? 'day' : currentPeriod === 'L90D' ? 'week' : 'month',
                                displayFormats: {
                                    day: 'MMM dd',
                                    week: 'MMM dd',
                                    month: 'MMM yyyy'
                                }
                            },
                            grid: { display: false },
                            ticks: {
                                font: { size: 11 },
                                maxTicksLimit: currentPeriod === 'L7D' ? 7 : currentPeriod === 'L30D' ? 8 : 6
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: { size: 11 },
                                precision: 0
                            },
                            title: {
                                display: true,
                                text: 'Cumulative Total',
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        function updateRevenueChart(revenue) {
            const ctx = document.getElementById('revenue-chart').getContext('2d');
            
            if (revenueChart) {
                revenueChart.destroy();
            }

            revenueChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Free', 'Starter', 'Pro', 'Business'],
                    datasets: [{
                        data: [
                            revenue.user_count_by_plan?.free || 0,
                            revenue.user_count_by_plan?.starter || 0,
                            revenue.user_count_by_plan?.pro || 0,
                            revenue.user_count_by_plan?.business || 0
                        ],
                        backgroundColor: ['#e5e7eb', '#22c55e', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 11 },
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function updateBusinessAnalytics(businessMetrics) {
            if (!businessMetrics) return;
            
            // Update engagement metrics
            const engagementRate = businessMetrics.engagement_rate || 0;
            document.getElementById('engagement-rate').textContent = engagementRate + '%';
            document.getElementById('engagement-bar').style.width = engagementRate + '%';
            
            document.getElementById('avg-conversations-per-user').textContent = businessMetrics.avg_conversations_per_user || '0';
            document.getElementById('avg-forms-per-user').textContent = businessMetrics.avg_forms_per_user || '0';
            
            // Update conversion funnel
            const funnel = businessMetrics.conversion_funnel || {};
            document.getElementById('funnel-visitors').textContent = (funnel.visitors || 0).toLocaleString();
            document.getElementById('funnel-signups').textContent = (funnel.signups || 0).toLocaleString();
            document.getElementById('funnel-creators').textContent = (funnel.form_creators || 0).toLocaleString();
            document.getElementById('funnel-active').textContent = (funnel.active_creators || 0).toLocaleString();
            
            // Update funnel chart
            updateFunnelChart(funnel);
            
            // Update top performing forms
            updateTopFormsList(businessMetrics.top_performing_forms || []);
        }

        function updateFunnelChart(funnel) {
            const ctx = document.getElementById('funnel-chart').getContext('2d');
            
            if (funnelChart) {
                funnelChart.destroy();
            }

            const visitors = funnel.visitors || 0;
            const signups = funnel.signups || 0;
            const creators = funnel.form_creators || 0;
            const active = funnel.active_creators || 0;

            // Calculate conversion rates
            const signupRate = visitors > 0 ? ((signups / visitors) * 100).toFixed(1) : 0;
            const creatorRate = signups > 0 ? ((creators / signups) * 100).toFixed(1) : 0;
            const activeRate = creators > 0 ? ((active / creators) * 100).toFixed(1) : 0;

            funnelChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Visitors', 'Signups', 'Form Creators', 'Active Forms'],
                    datasets: [{
                        label: 'Count',
                        data: [visitors, signups, creators, active],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)', 
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(249, 115, 22, 0.8)'
                        ],
                        borderColor: [
                            '#3b82f6',
                            '#10b981',
                            '#8b5cf6', 
                            '#f97316'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    if (index === 1) return `${signupRate}% conversion from visitors`;
                                    if (index === 2) return `${creatorRate}% of users create forms`;
                                    if (index === 3) return `${activeRate}% forms are active`;
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            ticks: { 
                                font: { size: 10 },
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        function updateTopFormsList(topForms) {
            const container = document.getElementById('top-forms-list');
            container.innerHTML = '';
            
            if (topForms.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500 text-center py-2">No form data available</div>';
                return;
            }
            
            topForms.slice(0, 5).forEach((form, index) => {
                const [formId, count] = form;
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center py-2 px-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium">${index + 1}</div>
                        <span class="text-sm text-gray-900 truncate max-w-[120px]">Form ${formId.slice(-8)}</span>
                    </div>
                    <span class="text-xs font-medium text-gray-600 bg-white px-2 py-1 rounded">${count} responses</span>
                `;
                container.appendChild(div);
            });
        }

        function updateActiveUsersList(users) {
            const container = document.getElementById('active-users-list');
            container.innerHTML = '';
            
            users.slice(0, 5).forEach(user => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center py-2 px-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <span class="text-sm text-gray-900 truncate max-w-[120px]">${user.email}</span>
                    <span class="text-xs font-medium text-gray-600 bg-white px-2 py-1 rounded">${user.activity_score}</span>
                `;
                container.appendChild(div);
            });
        }

        async function changePeriod(period) {
            // Update button states
            document.querySelectorAll('.period-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
            
            currentPeriod = period;
            showLoading(true);
            
            try {
                const response = await fetch(`/admin/api/trends?period=${period}`);
                if (!response.ok) throw new Error('Failed to fetch trends data');
                
                trendsData = await response.json();
                updateTrendsCharts(trendsData);
            } catch (error) {
                console.error('Error fetching trends:', error);
                showNotification('Failed to load trend data', 'error');
            } finally {
                showLoading(false);
            }
        }

        // User management functions
        async function searchUsers() {
            const query = document.getElementById('user-search').value;
            if (!query) return;

            try {
                const response = await fetch(`/admin/api/users/search?q=${encodeURIComponent(query)}`);
                const users = await response.json();
                
                const resultsDiv = document.getElementById('search-results');
                const resultsTable = document.getElementById('search-results-table');
                
                resultsDiv.classList.remove('hidden');
                resultsTable.innerHTML = '';
                
                users.forEach(user => {
                    const plan = user.subscription?.plan || 'free';
                    const planBadge = plan === 'free' ? 
                        'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800' :
                        'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                    
                    resultsTable.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 text-sm text-gray-900">${user.email}</td>
                            <td class="px-3 py-2 text-sm">
                                <span class="${planBadge}">${plan.toUpperCase()}</span>
                            </td>
                            <td class="px-3 py-2 text-sm text-right space-x-2">
                                <button onclick="viewUserDetails('${user.id}')" class="text-brand hover:text-brand/80">View</button>
                                <button onclick="grantGrandfather('${user.id}')" class="text-green-600 hover:text-green-800">Grandfather</button>
                            </td>
                        </tr>
                    `;
                });
                
                if (users.length === 0) {
                    resultsTable.innerHTML = '<tr><td colspan="3" class="px-3 py-3 text-sm text-gray-500 text-center">No users found</td></tr>';
                }
            } catch (error) {
                console.error('Error searching users:', error);
                showNotification('Failed to search users', 'error');
            }
        }

        async function viewUserDetails(userId) {
            try {
                const response = await fetch(`/admin/api/users/${userId}`);
                const data = await response.json();
                
                const modal = document.getElementById('user-details-modal');
                const content = document.getElementById('user-details-content');
                
                modal.classList.remove('hidden');
                
                const user = data.user;
                const usage = data.usage || {};
                const forms = data.forms || [];
                
                const plan = user.subscription?.plan || 'free';
                const isGrandfathered = plan.includes('grandfathered');
                const planDisplay = isGrandfathered ? 
                    plan.replace('grandfathered_', '').toUpperCase() + ' (Grandfathered)' : 
                    plan.toUpperCase();
                
                const planBadge = plan === 'free' ? 
                    'bg-gray-100 text-gray-800' : 
                    isGrandfathered ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800';
                
                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 rounded-xl p-4">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3">Profile Information</h4>
                            <dl class="space-y-2">
                                <div class="flex justify-between">
                                    <dt class="text-xs text-gray-500">Email</dt>
                                    <dd class="text-xs font-medium text-gray-900">${user.email}</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-xs text-gray-500">Plan</dt>
                                    <dd class="text-xs">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${planBadge}">
                                            ${planDisplay}
                                        </span>
                                    </dd>
                                </div>
                            </dl>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-4">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3">Usage Statistics</h4>
                            <dl class="space-y-2">
                                <div class="flex justify-between">
                                    <dt class="text-xs text-gray-500">Conversations</dt>
                                    <dd class="text-xs font-medium text-gray-900">${usage.conversations_count || 0}</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-xs text-gray-500">Forms Created</dt>
                                    <dd class="text-xs font-medium text-gray-900">${usage.forms_count || 0}</dd>
                                </div>
                            </dl>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 pt-4 border-t border-gray-200">
                        <button onclick="resetUsage('${userId}')" class="px-4 py-2 bg-yellow-600 text-white rounded-lg text-sm font-medium hover:bg-yellow-700 transition-colors">
                            <i class="ph ph-arrow-counter-clockwise mr-1"></i>
                            Reset Usage
                        </button>
                        <button onclick="grantGrandfather('${userId}')" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
                            <i class="ph ph-crown mr-1"></i>
                            Grant Grandfather
                        </button>
                    </div>
                `;
            } catch (error) {
                console.error('Error fetching user details:', error);
                showNotification('Failed to load user details', 'error');
            }
        }

        function closeUserDetails() {
            document.getElementById('user-details-modal').classList.add('hidden');
        }

        async function grantGrandfather(userId) {
            if (!confirm('Grant grandfathered status to this user?')) return;
            
            try {
                const response = await fetch(`/admin/api/users/${userId}/grandfather`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ plan_type: 'pro' })
                });
                
                if (response.ok) {
                    showNotification('Grandfathered status granted', 'success');
                    searchUsers();
                } else {
                    throw new Error('Failed to grant status');
                }
            } catch (error) {
                console.error('Error granting grandfather status:', error);
                showNotification('Failed to grant grandfather status', 'error');
            }
        }

        async function resetUsage(userId) {
            if (!confirm('Reset usage limits for this user?')) return;
            
            try {
                const response = await fetch(`/admin/api/users/${userId}/reset-usage`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showNotification('Usage reset successfully', 'success');
                    viewUserDetails(userId);
                } else {
                    throw new Error('Failed to reset usage');
                }
            } catch (error) {
                console.error('Error resetting usage:', error);
                showNotification('Failed to reset usage', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            const bgColor = type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-600';
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg text-sm z-50 transform transition-all duration-300`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('translate-y-0'), 10);
            setTimeout(() => {
                notification.classList.add('opacity-0', 'transform', 'translate-y-2');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        async function logout() {
            try {
                await fetch('/admin/logout', { method: 'POST' });
                window.location.href = '/admin';
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        // Enter key support for search
        document.getElementById('user-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchUsers();
            }
        });
    </script>
</body>
</html>