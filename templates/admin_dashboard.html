<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#cc5500">
    <title>Admin Dashboard - Barmuda</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans">
    <!-- Header -->
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center space-x-4">
                    <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <span class="w-2 h-2 bg-green-400 rounded-full mr-1.5"></span>
                        Last updated: <span id="last-updated" class="ml-1">--</span>
                    </span>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="refreshDashboard()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors">
                        <i class="ph ph-arrow-clockwise -ml-0.5 mr-2 h-4 w-4"></i>
                        Refresh
                    </button>
                    <button onclick="logout()" class="text-gray-400 hover:text-gray-500 transition-colors">
                        <i class="ph ph-sign-out h-6 w-6"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            
            <!-- MRR Card -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="ph ph-currency-dollar h-8 w-8 text-green-400"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Monthly Recurring Revenue</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900">$<span id="mrr">--</span></div>
                                    <div id="mrr-change" class="ml-2 flex items-baseline text-sm font-semibold">--</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Users Card -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="ph ph-users h-8 w-8 text-blue-400"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Total Users</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900" id="total-users">--</div>
                                    <div class="ml-2 text-sm text-gray-500">
                                        <span id="paid-users">--</span> paid, <span id="grandfathered-users">--</span> grandfathered
                                    </div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conversations Card -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="ph ph-chat-circle h-8 w-8 text-purple-400"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Conversations Today</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900" id="conversations-today">--</div>
                                    <div class="ml-2 text-sm text-gray-500">
                                        <span id="conversations-month">--</span> this month
                                    </div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Forms Card -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="ph ph-files h-8 w-8 text-orange-400"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Active Forms</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900" id="active-forms">--</div>
                                    <div class="ml-2 text-sm text-gray-500">
                                        <span id="total-forms">--</span> total
                                    </div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Revenue Details -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <i class="ph ph-chart-pie mr-3 h-5 w-5 text-gray-400"></i>
                        Revenue Breakdown
                    </h3>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-900">$<span id="total-revenue">--</span></div>
                            <div class="text-sm text-gray-500">Total Revenue</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-900" id="paying-customers">--</div>
                            <div class="text-sm text-gray-500">Paying Customers</div>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="revenue-chart"></canvas>
                    </div>
                    <div class="mt-4 flex justify-between text-sm">
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                            Churn: <span id="churn-rate" class="font-semibold ml-1">--%</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                            Retention: <span id="retention-rate" class="font-semibold ml-1">--%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Usage Analytics -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <i class="ph ph-chart-line mr-3 h-5 w-5 text-gray-400"></i>
                        Usage Analytics
                    </h3>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="text-center">
                            <div class="text-xl font-bold text-gray-900" id="conversations-week">--</div>
                            <div class="text-sm text-gray-500">This Week</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-bold text-gray-900" id="inactive-forms">--</div>
                            <div class="text-sm text-gray-500">Inactive Forms</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-bold text-gray-900" id="avg-conversations">--</div>
                            <div class="text-sm text-gray-500">Avg/Form</div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">Completion Rate</span>
                            <span class="text-sm font-semibold text-gray-900" id="completion-rate">--%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="completion-bar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500">Peak Hours:</span>
                            <div class="font-medium" id="peak-hours">--</div>
                        </div>
                        <div>
                            <span class="text-gray-500">Peak Days:</span>
                            <div class="font-medium" id="peak-days">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management & System Health -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
            
            <!-- User Management -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <i class="ph ph-user-gear mr-3 h-5 w-5 text-gray-400"></i>
                        User Management
                    </h3>
                </div>
                <div class="p-6">
                    <!-- Search -->
                    <div class="flex space-x-3 mb-4">
                        <input type="text" id="user-search" 
                               placeholder="Search by email..." 
                               class="flex-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                        <button onclick="searchUsers()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                            <i class="ph ph-magnifying-glass mr-1"></i>
                            Search
                        </button>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="search-results" class="hidden">
                        <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 rounded-md">
                            <table class="min-w-full divide-y divide-gray-300">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wide">Email</th>
                                        <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wide">Plan</th>
                                        <th scope="col" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wide">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="search-results-table" class="bg-white divide-y divide-gray-200">
                                    <!-- Results will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Most Active Users -->
                    <div class="mt-6">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Most Active Users</h4>
                        <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 rounded-md">
                            <table class="min-w-full divide-y divide-gray-300">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wide">User</th>
                                        <th scope="col" class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wide">Score</th>
                                    </tr>
                                </thead>
                                <tbody id="active-users-table" class="bg-white divide-y divide-gray-200">
                                    <!-- Will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Health -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <i class="ph ph-heartbeat mr-3 h-5 w-5 text-gray-400"></i>
                        System Health
                    </h3>
                </div>
                <div class="p-6">
                    <!-- API Performance -->
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">API Performance</h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-lg font-semibold text-gray-900" id="api-avg">-- ms</div>
                                <div class="text-xs text-gray-500">Average</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-semibold text-gray-900" id="api-p95">-- ms</div>
                                <div class="text-xs text-gray-500">P95</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-semibold text-gray-900" id="api-p99">-- ms</div>
                                <div class="text-xs text-gray-500">P99</div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Rates -->
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Error Rates</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">API Errors</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800" id="api-errors">--%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Chat Errors</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800" id="chat-errors">--%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Payment Errors</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800" id="payment-errors">--%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Service Costs -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="text-xs font-medium text-gray-900 mb-2 flex items-center">
                                <i class="ph ph-database mr-1 h-4 w-4"></i>
                                Firebase Today
                            </h5>
                            <div class="space-y-1">
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-600">Reads</span>
                                    <span class="font-medium" id="firebase-reads">--</span>
                                </div>
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-600">Writes</span>
                                    <span class="font-medium" id="firebase-writes">--</span>
                                </div>
                                <div class="flex justify-between text-xs border-t pt-1">
                                    <span class="text-gray-600">Cost</span>
                                    <span class="font-semibold text-green-600">$<span id="firebase-cost">--</span></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="text-xs font-medium text-gray-900 mb-2 flex items-center">
                                <i class="ph ph-robot mr-1 h-4 w-4"></i>
                                OpenAI Today
                            </h5>
                            <div class="space-y-1">
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-600">Tokens</span>
                                    <span class="font-medium" id="openai-tokens">--</span>
                                </div>
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-600">Calls</span>
                                    <span class="font-medium" id="openai-calls">--</span>
                                </div>
                                <div class="flex justify-between text-xs border-t pt-1">
                                    <span class="text-gray-600">Cost</span>
                                    <span class="font-semibold text-green-600">$<span id="openai-cost">--</span></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dodo Status -->
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-900 flex items-center">
                                <i class="ph ph-credit-card mr-2 h-4 w-4"></i>
                                Dodo Payments
                            </span>
                            <span id="dodo-status-badge" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <span class="w-1.5 h-1.5 bg-green-400 rounded-full mr-1"></span>
                                <span id="dodo-status">Operational</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- A/B Testing Lab -->
            <div class="bg-white shadow rounded-lg mt-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-medium text-gray-900 flex items-center">
                            <i class="ph ph-flask mr-3 h-5 w-5 text-purple-500"></i>
                            A/B Testing Lab
                        </h3>
                        <div class="flex items-center space-x-3">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <span class="w-1.5 h-1.5 bg-green-400 rounded-full mr-1"></span>
                                Active
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Current A/B Test -->
                <div class="p-6">
                    <div class="border-l-4 border-purple-400 bg-purple-50 p-4 mb-6">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-lg font-semibold text-purple-900 flex items-center">
                                <i class="ph ph-crosshair mr-2"></i>
                                Test #001: Landing Page Positioning
                            </h4>
                            <div class="text-sm text-purple-700">
                                Started: <span id="test-start-date">Jan 8, 2025</span>
                            </div>
                        </div>
                        <p class="text-sm text-purple-800 mb-4">
                            Testing generic form builder messaging vs user research positioning to optimize conversion rates.
                        </p>
                        
                        <!-- Test Variants -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                            <div class="bg-white rounded-lg p-4 border-2 border-blue-200">
                                <div class="flex items-center justify-between mb-2">
                                    <h5 class="font-semibold text-blue-900 flex items-center">
                                        <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                                        Version A (Control)
                                    </h5>
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">index_a.html</span>
                                </div>
                                <p class="text-sm text-blue-700 mb-3">"People hate filling out forms"</p>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600" id="ab-impressions-a">--</div>
                                    <div class="text-xs text-blue-500">visitors</div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4 border-2 border-orange-200">
                                <div class="flex items-center justify-between mb-2">
                                    <h5 class="font-semibold text-orange-900 flex items-center">
                                        <span class="w-3 h-3 bg-orange-500 rounded-full mr-2"></span>
                                        Version B (Variant)
                                    </h5>
                                    <span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded">index_b.html</span>
                                </div>
                                <p class="text-sm text-orange-700 mb-3">"User feedback at scale"</p>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-orange-600" id="ab-impressions-b">--</div>
                                    <div class="text-xs text-orange-500">visitors</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conversion Metrics -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Signup Conversions -->
                            <div class="bg-white rounded-lg border border-gray-200 p-4">
                                <h6 class="font-medium text-gray-900 mb-3 flex items-center">
                                    <i class="ph ph-user-plus mr-2 text-green-500"></i>
                                    Signup Conversion
                                </h6>
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-center">
                                        <div class="text-lg font-bold text-blue-600" id="ab-signup-a">--%</div>
                                        <div class="text-xs text-gray-500">Version A</div>
                                    </div>
                                    <div class="text-center px-3">
                                        <div class="text-sm text-gray-400">vs</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-bold text-orange-600" id="ab-signup-b">--%</div>
                                        <div class="text-xs text-gray-500">Version B</div>
                                    </div>
                                </div>
                                <div class="text-center pt-2 border-t border-gray-100">
                                    <span id="ab-signup-lift" class="text-sm font-semibold">--% lift</span>
                                </div>
                            </div>
                            
                            <!-- Form Creation Conversions -->
                            <div class="bg-white rounded-lg border border-gray-200 p-4">
                                <h6 class="font-medium text-gray-900 mb-3 flex items-center">
                                    <i class="ph ph-plus-circle mr-2 text-blue-500"></i>
                                    Form Creation
                                </h6>
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-center">
                                        <div class="text-lg font-bold text-blue-600" id="ab-form-a">--%</div>
                                        <div class="text-xs text-gray-500">Version A</div>
                                    </div>
                                    <div class="text-center px-3">
                                        <div class="text-sm text-gray-400">vs</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-bold text-orange-600" id="ab-form-b">--%</div>
                                        <div class="text-xs text-gray-500">Version B</div>
                                    </div>
                                </div>
                                <div class="text-center pt-2 border-t border-gray-100">
                                    <span id="ab-form-lift" class="text-sm font-semibold">--% lift</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Test Actions -->
                        <div class="mt-6 flex items-center justify-between pt-4 border-t border-purple-200">
                            <div class="text-sm text-purple-700">
                                <strong>Status:</strong> Running â€¢ <strong>Traffic Split:</strong> 50/50
                            </div>
                            <div class="flex space-x-2">
                                <button class="inline-flex items-center px-3 py-1.5 border border-purple-300 text-sm font-medium rounded text-purple-700 bg-white hover:bg-purple-50 transition-colors">
                                    <i class="ph ph-pause mr-1"></i>
                                    Pause Test
                                </button>
                                <button class="inline-flex items-center px-3 py-1.5 bg-purple-600 text-sm font-medium rounded text-white hover:bg-purple-700 transition-colors">
                                    <i class="ph ph-trophy mr-1"></i>
                                    Declare Winner
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Future Tests Placeholder -->
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <i class="ph ph-plus-circle text-3xl text-gray-400 mb-2"></i>
                        <h5 class="text-lg font-medium text-gray-900 mb-2">Ready for Your Next Test?</h5>
                        <p class="text-sm text-gray-500 mb-4">
                            Plan your next A/B test to optimize pricing pages, onboarding flows, or feature messaging.
                        </p>
                        <button class="inline-flex items-center px-4 py-2 bg-purple-600 text-sm font-medium rounded-md text-white hover:bg-purple-700 transition-colors">
                            <i class="ph ph-flask mr-2"></i>
                            Create New Test
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Details Modal -->
        <div id="user-details-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeUserDetails()"></div>
                <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full sm:p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900 flex items-center">
                            <i class="ph ph-user-circle mr-2 h-6 w-6"></i>
                            User Details
                        </h3>
                        <button onclick="closeUserDetails()" class="text-gray-400 hover:text-gray-500">
                            <i class="ph ph-x h-6 w-6"></i>
                        </button>
                    </div>
                    <div id="user-details-content" class="space-y-6">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        let dashboardData = null;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date for the A/B test
            const today = new Date();
            const formattedDate = today.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
            document.getElementById('test-start-date').textContent = formattedDate;
            
            refreshDashboard();
            setInterval(refreshDashboard, 30000); // Auto-refresh every 30 seconds
        });
        
        async function refreshDashboard() {
            try {
                // Fetch both dashboard and A/B test data
                const [dashboardResponse, abTestResponse] = await Promise.all([
                    fetch('/admin/api/dashboard'),
                    fetch('/admin/api/ab-test')
                ]);
                
                if (!dashboardResponse.ok) throw new Error('Failed to fetch dashboard data');
                
                dashboardData = await dashboardResponse.json();
                updateDashboard(dashboardData);
                
                // Update A/B test data if available
                if (abTestResponse.ok) {
                    const abTestData = await abTestResponse.json();
                    updateABTestResults(abTestData);
                }
                
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                showNotification('Failed to load dashboard data', 'error');
            }
        }
        
        function updateDashboard(data) {
            // Revenue Metrics
            const revenue = data.revenue || {};
            document.getElementById('mrr').textContent = revenue.mrr?.toFixed(0) || '0';
            document.getElementById('total-revenue').textContent = revenue.total_revenue?.toFixed(0) || '0';
            document.getElementById('paying-customers').textContent = revenue.paying_customers || '0';
            document.getElementById('grandfathered-users').textContent = revenue.grandfathered_users || '0';
            document.getElementById('churn-rate').textContent = (revenue.churn_rate || 0) + '%';
            document.getElementById('retention-rate').textContent = (revenue.retention_rate || 0) + '%';
            
            // MRR Change with pill badge
            const mrrChange = revenue.mrr_growth || 0;
            const mrrChangeEl = document.getElementById('mrr-change');
            const changeClass = mrrChange >= 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            mrrChangeEl.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${changeClass}">
                ${mrrChange >= 0 ? '+' : ''}${mrrChange.toFixed(1)}%
            </span>`;
            
            // Usage Analytics
            const usage = data.usage || {};
            document.getElementById('conversations-today').textContent = usage.conversations_today || '0';
            document.getElementById('conversations-week').textContent = usage.conversations_week || '0';
            document.getElementById('conversations-month').textContent = usage.conversations_month || '0';
            document.getElementById('active-forms').textContent = usage.active_forms || '0';
            document.getElementById('inactive-forms').textContent = usage.inactive_forms || '0';
            document.getElementById('total-forms').textContent = usage.total_forms || '0';
            document.getElementById('avg-conversations').textContent = usage.avg_conversations_per_form?.toFixed(1) || '0';
            document.getElementById('completion-rate').textContent = (usage.completion_rate || 0) + '%';
            document.getElementById('completion-bar').style.width = (usage.completion_rate || 0) + '%';
            
            // Peak usage
            document.getElementById('peak-hours').textContent = usage.peak_hours?.map(h => h + ':00').join(', ') || '--';
            document.getElementById('peak-days').textContent = usage.peak_days?.slice(0, 3).join(', ') || '--';
            
            // User Metrics
            const users = data.users || {};
            document.getElementById('total-users').textContent = users.total_users || '0';
            document.getElementById('paid-users').textContent = users.paid_users || '0';
            
            // Most active users table
            const activeUsersTable = document.getElementById('active-users-table');
            activeUsersTable.innerHTML = '';
            (users.most_active_users || []).slice(0, 5).forEach(user => {
                activeUsersTable.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 text-xs text-gray-900 truncate max-w-[200px]">${user.email}</td>
                        <td class="px-3 py-2 text-xs text-gray-900 text-right font-medium">${user.activity_score}</td>
                    </tr>
                `;
            });
            
            // System Health
            const health = data.health || {};
            document.getElementById('api-avg').textContent = (health.api_response_time?.avg || 0) + ' ms';
            document.getElementById('api-p95').textContent = (health.api_response_time?.p95 || 0) + ' ms';
            document.getElementById('api-p99').textContent = (health.api_response_time?.p99 || 0) + ' ms';
            
            document.getElementById('api-errors').textContent = (health.error_rates?.api_errors || 0) + '%';
            document.getElementById('chat-errors').textContent = (health.error_rates?.chat_errors || 0) + '%';
            document.getElementById('payment-errors').textContent = (health.error_rates?.payment_errors || 0) + '%';
            
            // Firebase usage
            document.getElementById('firebase-reads').textContent = (health.firebase_usage?.reads_today || 0).toLocaleString();
            document.getElementById('firebase-writes').textContent = (health.firebase_usage?.writes_today || 0).toLocaleString();
            document.getElementById('firebase-cost').textContent = (health.firebase_usage?.estimated_cost || 0).toFixed(2);
            
            // OpenAI usage
            document.getElementById('openai-tokens').textContent = (health.openai_usage?.tokens_today || 0).toLocaleString();
            document.getElementById('openai-calls').textContent = (health.openai_usage?.api_calls || 0).toLocaleString();
            document.getElementById('openai-cost').textContent = (health.openai_usage?.estimated_cost || 0).toFixed(2);
            
            // Dodo status
            const dodoStatus = health.dodo_status || {};
            document.getElementById('dodo-status').textContent = dodoStatus.status || 'Unknown';
            const statusBadge = document.getElementById('dodo-status-badge');
            if (dodoStatus.status === 'operational') {
                statusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
            } else {
                statusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
            }
            
            // Update revenue chart
            updateRevenueChart(revenue);
        }
        
        function updateRevenueChart(revenue) {
            const ctx = document.getElementById('revenue-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.revenueChart) {
                window.revenueChart.destroy();
            }
            
            window.revenueChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Free', 'Starter', 'Pro', 'Business'],
                    datasets: [{
                        data: [
                            revenue.user_count_by_plan?.free || 0,
                            revenue.user_count_by_plan?.starter || 0,
                            revenue.user_count_by_plan?.pro || 0,
                            revenue.user_count_by_plan?.business || 0
                        ],
                        backgroundColor: ['#e5e7eb', '#22c55e', '#f59e0b', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 12 },
                                padding: 10
                            }
                        }
                    }
                }
            });
        }
        
        function updateABTestResults(data) {
            // Update impression counts
            document.getElementById('ab-impressions-a').textContent = data.impressions.A || 0;
            document.getElementById('ab-impressions-b').textContent = data.impressions.B || 0;
            
            // Update signup conversion rates
            const signupA = data.conversion_rates.signup.A;
            const signupB = data.conversion_rates.signup.B;
            const signupLift = data.conversion_rates.signup.lift;
            
            document.getElementById('ab-signup-a').textContent = signupA + '%';
            document.getElementById('ab-signup-b').textContent = signupB + '%';
            
            const signupLiftElement = document.getElementById('ab-signup-lift');
            signupLiftElement.textContent = (signupLift > 0 ? '+' : '') + signupLift + '%';
            signupLiftElement.className = 'font-medium ' + (signupLift > 0 ? 'text-green-600' : signupLift < 0 ? 'text-red-600' : 'text-gray-600');
            
            // Update form creation conversion rates
            const formA = data.conversion_rates.form_created.A;
            const formB = data.conversion_rates.form_created.B;
            const formLift = data.conversion_rates.form_created.lift;
            
            document.getElementById('ab-form-a').textContent = formA + '%';
            document.getElementById('ab-form-b').textContent = formB + '%';
            
            const formLiftElement = document.getElementById('ab-form-lift');
            formLiftElement.textContent = (formLift > 0 ? '+' : '') + formLift + '%';
            formLiftElement.className = 'font-medium ' + (formLift > 0 ? 'text-green-600' : formLift < 0 ? 'text-red-600' : 'text-gray-600');
        }
        
        async function searchUsers() {
            const query = document.getElementById('user-search').value;
            if (!query) return;
            
            try {
                const response = await fetch(`/admin/api/users/search?q=${encodeURIComponent(query)}`);
                const users = await response.json();
                
                const resultsDiv = document.getElementById('search-results');
                const resultsTable = document.getElementById('search-results-table');
                
                resultsDiv.classList.remove('hidden');
                resultsTable.innerHTML = '';
                
                users.forEach(user => {
                    const plan = user.subscription?.plan || 'free';
                    const planBadge = plan === 'free' ? 
                        'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800' :
                        'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                    
                    resultsTable.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-3 text-sm text-gray-900">${user.email}</td>
                            <td class="px-3 py-3 text-sm">
                                <span class="${planBadge}">${plan.toUpperCase()}</span>
                            </td>
                            <td class="px-3 py-3 text-sm text-right space-x-2">
                                <button onclick="viewUserDetails('${user.id}')" class="text-orange-600 hover:text-orange-900">View</button>
                                <button onclick="grantGrandfather('${user.id}')" class="text-green-600 hover:text-green-900">Grandfather</button>
                            </td>
                        </tr>
                    `;
                });
                
                if (users.length === 0) {
                    resultsTable.innerHTML = '<tr><td colspan="3" class="px-3 py-3 text-sm text-gray-500 text-center">No users found</td></tr>';
                }
            } catch (error) {
                console.error('Error searching users:', error);
                showNotification('Failed to search users', 'error');
            }
        }
        
        async function viewUserDetails(userId) {
            try {
                const response = await fetch(`/admin/api/users/${userId}`);
                const data = await response.json();
                
                const modal = document.getElementById('user-details-modal');
                const content = document.getElementById('user-details-content');
                
                modal.classList.remove('hidden');
                
                const user = data.user;
                const usage = data.usage || {};
                const forms = data.forms || [];
                const recentResponses = data.recent_responses || [];
                
                // Calculate plan status
                const plan = user.subscription?.plan || 'free';
                const isGrandfathered = plan.includes('grandfathered');
                const planDisplay = isGrandfathered ? 
                    plan.replace('grandfathered_', '').toUpperCase() + ' (Grandfathered)' : 
                    plan.toUpperCase();
                
                const planBadge = plan === 'free' ? 
                    'bg-gray-100 text-gray-800' : 
                    isGrandfathered ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800';
                
                content.innerHTML = `
                    <!-- User Overview -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 mb-3 flex items-center">
                                <i class="ph ph-identification-card mr-2 h-4 w-4"></i>
                                Profile Information
                            </h4>
                            <dl class="space-y-2">
                                <div class="flex justify-between">
                                    <dt class="text-xs text-gray-500">Email</dt>
                                    <dd class="text-xs font-medium text-gray-900">${user.email}</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-xs text-gray-500">User ID</dt>
                                    <dd class="text-xs font-mono text-gray-600">${userId}</dd>
                                </div>
                                <div class="flex justify-between items-center">
                                    <dt class="text-xs text-gray-500">Plan</dt>
                                    <dd class="text-xs">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${planBadge}">
                                            ${planDisplay}
                                        </span>
                                    </dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-xs text-gray-500">Created</dt>
                                    <dd class="text-xs text-gray-900">${user.created_at ? new Date(user.created_at.seconds * 1000).toLocaleDateString() : 'Unknown'}</dd>
                                </div>
                            </dl>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 mb-3 flex items-center">
                                <i class="ph ph-chart-bar mr-2 h-4 w-4"></i>
                                Usage Statistics
                            </h4>
                            <dl class="space-y-2">
                                <div class="flex justify-between">
                                    <dt class="text-xs text-gray-500">Conversations</dt>
                                    <dd class="text-xs font-medium text-gray-900">${usage.conversations_count || 0}</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-xs text-gray-500">Forms Created</dt>
                                    <dd class="text-xs font-medium text-gray-900">${usage.forms_count || 0}</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-xs text-gray-500">Current Month</dt>
                                    <dd class="text-xs text-gray-900">${usage.current_month || new Date().toISOString().slice(0, 7)}</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-xs text-gray-500">Last Activity</dt>
                                    <dd class="text-xs text-gray-900">${usage.updated_at ? new Date(usage.updated_at.seconds * 1000).toLocaleDateString() : 'No activity'}</dd>
                                </div>
                            </dl>
                        </div>
                    </div>
                    
                    <!-- Forms Created -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 mb-3 flex items-center">
                            <i class="ph ph-files mr-2 h-4 w-4"></i>
                            Forms Created (${forms.length})
                        </h4>
                        ${forms.length > 0 ? `
                            <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 rounded-md">
                                <table class="min-w-full divide-y divide-gray-300">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Created</th>
                                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${forms.map(form => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-3 py-3 text-xs text-gray-900 max-w-xs truncate">${form.title}</td>
                                                <td class="px-3 py-3 text-center">
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${form.active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                                        ${form.active ? 'Active' : 'Inactive'}
                                                    </span>
                                                </td>
                                                <td class="px-3 py-3 text-center text-xs text-gray-500">
                                                    ${form.created_at ? new Date(form.created_at.seconds * 1000).toLocaleDateString() : 'Unknown'}
                                                </td>
                                                <td class="px-3 py-3 text-right text-xs">
                                                    <a href="/form/${form.id}" target="_blank" class="text-orange-600 hover:text-orange-900">View</a>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="text-center py-6 bg-gray-50 rounded-lg">
                                <i class="ph ph-files h-12 w-12 text-gray-300 mx-auto mb-2"></i>
                                <p class="text-sm text-gray-500">No forms created yet</p>
                            </div>
                        `}
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-3 pt-4 border-t border-gray-200">
                        <button onclick="resetUsage('${userId}')" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                            <i class="ph ph-arrow-counter-clockwise -ml-0.5 mr-2 h-4 w-4"></i>
                            Reset Usage
                        </button>
                        <button onclick="grantGrandfather('${userId}')" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <i class="ph ph-crown -ml-0.5 mr-2 h-4 w-4"></i>
                            Grant Grandfather
                        </button>
                        <button onclick="exportUserData('${userId}')" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                            <i class="ph ph-download -ml-0.5 mr-2 h-4 w-4"></i>
                            Export Data
                        </button>
                    </div>
                `;
            } catch (error) {
                console.error('Error fetching user details:', error);
                showNotification('Failed to load user details', 'error');
            }
        }
        
        function closeUserDetails() {
            document.getElementById('user-details-modal').classList.add('hidden');
        }
        
        async function grantGrandfather(userId) {
            if (!confirm('Grant grandfathered status to this user?')) return;
            
            try {
                const response = await fetch(`/admin/api/users/${userId}/grandfather`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ plan_type: 'pro' })
                });
                
                if (response.ok) {
                    showNotification('Grandfathered status granted', 'success');
                    searchUsers(); // Refresh search results
                } else {
                    throw new Error('Failed to grant status');
                }
            } catch (error) {
                console.error('Error granting grandfather status:', error);
                showNotification('Failed to grant grandfather status', 'error');
            }
        }
        
        async function resetUsage(userId) {
            if (!confirm('Reset usage limits for this user?')) return;
            
            try {
                const response = await fetch(`/admin/api/users/${userId}/reset-usage`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showNotification('Usage reset successfully', 'success');
                    viewUserDetails(userId); // Refresh details
                } else {
                    throw new Error('Failed to reset usage');
                }
            } catch (error) {
                console.error('Error resetting usage:', error);
                showNotification('Failed to reset usage', 'error');
            }
        }
        
        async function exportUserData(userId) {
            try {
                const response = await fetch(`/admin/api/users/${userId}/export`);
                const data = await response.json();
                
                // Download as JSON
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `user_${userId}_export.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('User data exported', 'success');
            } catch (error) {
                console.error('Error exporting user data:', error);
                showNotification('Failed to export user data', 'error');
            }
        }
        
        function showNotification(message, type = 'info') {
            const bgColor = type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-600';
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg text-sm z-50 transform transition-all duration-300`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => notification.classList.add('translate-y-0'), 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('opacity-0', 'transform', 'translate-y-2');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        async function logout() {
            try {
                await fetch('/admin/logout', { method: 'POST' });
                window.location.href = '/admin';
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }
        
        // Add Enter key support for search
        document.getElementById('user-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchUsers();
            }
        });
    </script>
</body>
</html>