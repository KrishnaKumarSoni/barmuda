<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#cc5500">
    <title>Refine Form - Barmuda</title>

    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7C7SPTNMLT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-7C7SPTNMLT', {
            anonymize_ip: true,
            allow_google_signals: false,
            allow_ad_personalization_signals: false
        });
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bermuda-orange': '#cc5500',
                        'bermuda-red': '#d12b2e',
                        'bermuda-cream': '#fef5e0',
                        'bermuda-light-cream': '#ffffff',
                        'bermuda-border': '#fbe7bd',
                        'bermuda-nav-border': '#fff0cf',
                        'bermuda-text': '#1e1e1e',
                        'bermuda-gray': '#5e5d5d',
                        'bermuda-light-gray': '#797878',
                        'bermuda-disabled': '#acaaaa'
                    },
                    fontFamily: {
                        'jakarta': ['Plus Jakarta Sans', 'sans-serif'],
                        'dm': ['DM Sans', 'sans-serif']
                    },
                    spacing: {
                        '18': '4.5rem',
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* Custom Slider Styling */
        .slider {
            -webkit-appearance: none;
            background: #e5e7eb;
            outline: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #cc5500;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #cc5500;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .slider:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 3px rgba(204, 85, 0, 0.3);
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
</head>
<body class="bg-bermuda-cream min-h-screen font-dm">
    {% set nav_type = 'edit_form' %}
    {% include 'partials/nav.html' %}

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-6 md:px-8 pt-24 md:pt-28 pb-12">
        <!-- Go Back -->
        <div class="flex items-center gap-2 mb-6">
            <button onclick="goBack()" class="flex items-center gap-2 text-bermuda-light-gray hover:text-bermuda-orange transition-colors group">
                <i class="ph ph-caret-left text-lg group-hover:-translate-x-0.5 transition-transform"></i>
                <span class="font-jakarta font-semibold text-sm">Go Back</span>
            </button>
        </div>

        <!-- Page Title -->
        <h1 class="font-jakarta font-bold text-2xl md:text-3xl text-bermuda-text mb-8">
            Refine Your Form
        </h1>

        <!-- Form Title Section -->
        <div class="mb-6">
            <h2 class="font-jakarta font-semibold text-base text-bermuda-text mb-2">Form Title</h2>
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow p-3">
                <input
                    type="text"
                    id="formTitle"
                    class="w-full font-jakarta font-semibold text-lg text-bermuda-text bg-transparent outline-none placeholder:text-gray-400"
                    placeholder="Enter your form title"
                >
            </div>
        </div>

        <!-- Bot Context Section -->
        <div class="mb-6">
            <h2 class="font-jakarta font-semibold text-base text-bermuda-text mb-2">Bot Context <span class="text-xs font-normal text-gray-500">(Optional)</span></h2>
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow p-3">
                <textarea
                    id="botContext"
                    rows="3"
                    class="w-full font-dm text-sm text-bermuda-text bg-transparent outline-none resize-none placeholder:text-gray-400"
                    placeholder="Give your bot personality and context (e.g., 'Hi! I'm Sarah from the marketing team...')"
                ></textarea>
            </div>
            <p class="text-xs text-gray-500 mt-1.5 flex items-start gap-1">
                <i class="ph ph-info text-bermuda-orange text-xs mt-0.5"></i>
                <span>Helps your bot answer contextual questions naturally</span>
            </p>
        </div>

        <!-- Form Mode Selection -->
        <div class="mb-6 bg-white rounded-lg border border-gray-200 shadow-sm p-4">
            <h2 class="font-jakarta font-semibold text-base text-bermuda-text mb-3">Response Mode</h2>
            <div class="grid grid-cols-2 gap-3">
                <button
                    id="chatModeBtn"
                    onclick="setFormMode('chat')"
                    class="flex items-center gap-3 p-3 border-2 border-bermuda-orange rounded-lg bg-bermuda-orange/5 transition-all"
                >
                    <i class="ph ph-chat-circle-text text-bermuda-orange text-xl"></i>
                    <div class="text-left">
                        <div class="font-jakarta font-semibold text-sm text-bermuda-text">Chat Mode</div>
                        <div class="font-dm text-xs text-bermuda-gray">Text-based conversation</div>
                    </div>
                </button>
                <button
                    id="voiceModeBtn"
                    onclick="setFormMode('voice')"
                    class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg hover:border-bermuda-orange transition-all"
                >
                    <i class="ph ph-microphone text-bermuda-gray text-xl"></i>
                    <div class="text-left">
                        <div class="font-jakarta font-semibold text-sm text-bermuda-text">Voice Mode</div>
                        <div class="font-dm text-xs text-bermuda-gray">AI voice conversation</div>
                    </div>
                </button>
            </div>
            
            <!-- Voice Settings (hidden by default) -->
            <div id="voiceSettings" class="hidden mt-4 p-4 bg-white border border-gray-200 rounded-lg">
                <h3 class="font-jakarta font-semibold text-base text-bermuda-text mb-4 flex items-center gap-2">
                    <i class="ph ph-microphone text-bermuda-orange"></i>
                    Voice Settings
                </h3>
                
                <div class="space-y-4">
                    <!-- Language Selection -->
                    <div>
                        <label class="font-dm text-sm font-medium text-bermuda-text mb-2 block">Language</label>
                        <div class="relative">
                            <button type="button" id="languageDropdownBtn" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm bg-white hover:border-bermuda-orange focus:border-bermuda-orange focus:ring-1 focus:ring-bermuda-orange transition-colors text-left flex items-center justify-between">
                                <span id="selectedLanguage" class="text-gray-500">Select Language</span>
                                <i class="ph ph-caret-down text-gray-400"></i>
                            </button>
                            <div id="languageDropdown" class="hidden absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-64 overflow-y-auto">
                                <div class="p-2 space-y-1">
                                    <!-- English -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="en" data-label="🇺🇸 English (US)">🇺🇸 English (US)</div>
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="en-GB" data-label="🇬🇧 English (UK)">🇬🇧 English (UK)</div>
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="en-AU" data-label="🇦🇺 English (Australia)">🇦🇺 English (Australia)</div>
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="en-IN" data-label="🇮🇳 English (India)">🇮🇳 English (India)</div>
                                    <!-- Spanish -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="es" data-label="🇪🇸 Spanish (Spain)">🇪🇸 Spanish (Spain)</div>
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="es-MX" data-label="🇲🇽 Spanish (Mexico)">🇲🇽 Spanish (Mexico)</div>
                                    <!-- French -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="fr" data-label="🇫🇷 French (France)">🇫🇷 French (France)</div>
                                    <!-- German -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="de" data-label="🇩🇪 German">🇩🇪 German</div>
                                    <!-- Italian -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="it" data-label="🇮🇹 Italian">🇮🇹 Italian</div>
                                    <!-- Portuguese -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="pt" data-label="🇵🇹 Portuguese (Portugal)">🇵🇹 Portuguese (Portugal)</div>
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="pt-BR" data-label="🇧🇷 Portuguese (Brazil)">🇧🇷 Portuguese (Brazil)</div>
                                    <!-- Hindi -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="hi" data-label="🇮🇳 Hindi">🇮🇳 Hindi</div>
                                    <!-- Japanese -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="ja" data-label="🇯🇵 Japanese">🇯🇵 Japanese</div>
                                    <!-- Korean -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="ko" data-label="🇰🇷 Korean">🇰🇷 Korean</div>
                                    <!-- Chinese -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="zh" data-label="🇨🇳 Chinese (Mandarin)">🇨🇳 Chinese (Mandarin)</div>
                                    <!-- Arabic -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="ar" data-label="🇸🇦 Arabic">🇸🇦 Arabic</div>
                                    <!-- Russian -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="ru" data-label="🇷🇺 Russian">🇷🇺 Russian</div>
                                    <!-- Dutch -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="nl" data-label="🇳🇱 Dutch">🇳🇱 Dutch</div>
                                    <!-- Polish -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="pl" data-label="🇵🇱 Polish">🇵🇱 Polish</div>
                                    <!-- Turkish -->
                                    <div class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm" data-value="tr" data-label="🇹🇷 Turkish">🇹🇷 Turkish</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Voice Selection -->
                    <div>
                        <label class="font-dm text-sm font-medium text-bermuda-text mb-2 block">Voice</label>
                        <div class="relative">
                            <button type="button" id="voiceDropdownBtn" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm bg-white hover:border-bermuda-orange focus:border-bermuda-orange focus:ring-1 focus:ring-bermuda-orange transition-colors text-left flex items-center justify-between disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <span id="selectedVoice" class="text-gray-500">Select a language first</span>
                                <i class="ph ph-caret-down text-gray-400"></i>
                            </button>
                            <div id="voiceDropdown" class="hidden absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-64 overflow-y-auto">
                                <div id="voiceOptions" class="p-2 space-y-1">
                                    <!-- Voice options will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Voice Modulation Settings -->
                    <div class="border-t border-gray-200 pt-4">
                        <h4 class="font-dm text-sm font-medium text-bermuda-text mb-3">Voice Modulation</h4>
                        <div class="space-y-3">
                            <!-- Stability -->
                            <div>
                                <label class="font-dm text-xs text-bermuda-gray mb-1 block flex items-center justify-between">
                                    Stability
                                    <span id="stabilityValue" class="text-bermuda-orange font-medium">0.5</span>
                                </label>
                                <input type="range" id="stabilitySlider" min="0" max="1" step="0.1" value="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                                <div class="flex justify-between text-xs text-gray-400 mt-1">
                                    <span>Variable</span>
                                    <span>Stable</span>
                                </div>
                            </div>
                            
                            <!-- Clarity + Similarity Boost -->
                            <div>
                                <label class="font-dm text-xs text-bermuda-gray mb-1 block flex items-center justify-between">
                                    Clarity
                                    <span id="clarityValue" class="text-bermuda-orange font-medium">0.8</span>
                                </label>
                                <input type="range" id="claritySlider" min="0" max="1" step="0.1" value="0.8" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                                <div class="flex justify-between text-xs text-gray-400 mt-1">
                                    <span>Soft</span>
                                    <span>Clear</span>
                                </div>
                            </div>
                            
                            <!-- Style -->
                            <div>
                                <label class="font-dm text-xs text-bermuda-gray mb-1 block flex items-center justify-between">
                                    Style Exaggeration
                                    <span id="styleValue" class="text-bermuda-orange font-medium">0.0</span>
                                </label>
                                <input type="range" id="styleSlider" min="0" max="1" step="0.1" value="0.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                                <div class="flex justify-between text-xs text-gray-400 mt-1">
                                    <span>Natural</span>
                                    <span>Expressive</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Voice Preview -->
                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                        <button 
                            id="previewVoiceBtn" 
                            type="button" 
                            class="flex items-center gap-2 px-4 py-2 bg-bermuda-orange text-white rounded-lg hover:bg-bermuda-orange/90 transition-colors text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            <i class="ph ph-play text-white"></i>
                            Preview Voice
                        </button>
                        <div id="previewText" class="text-sm text-bermuda-gray">
                            Select a voice to hear a preview
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Questions Container -->
        <div id="questionsContainer">
            <!-- Questions will be dynamically inserted here -->
        </div>

        <!-- Add Question Button -->
        <div class="flex justify-center my-6">
            <button
                onclick="addQuestion()"
                class="flex items-center gap-2 px-4 py-2 border border-bermuda-orange rounded-full text-bermuda-orange font-dm text-sm font-medium hover:bg-bermuda-orange hover:text-white transition-all"
            >
                <i class="ph ph-plus text-current text-base"></i>
                Add Question
            </button>
        </div>

        <!-- Demographics Section -->
        <div class="border-t border-gray-200 pt-6 mt-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-jakarta font-semibold text-base text-bermuda-text">Demographics</h2>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" id="demographicsCheckbox" onchange="toggleDemographics()">
                    <div class="w-12 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-bermuda-orange/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-bermuda-orange shadow-inner"></div>
                </label>
            </div>


            <!-- Demographics Grid -->
            <div id="demographicsGrid" class="grid grid-cols-3 gap-4 hidden">
                <!-- Demographics options will be populated here -->
            </div>
        </div>

        <!-- Profile Data Section -->
        <div class="border-t border-gray-200 pt-6 mt-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-jakarta font-semibold text-base text-bermuda-text">Profile Data</h2>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" id="profileDataCheckbox" onchange="toggleProfileData()">
                    <div class="w-12 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-bermuda-orange/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-bermuda-orange shadow-inner"></div>
                </label>
            </div>

            <!-- Profile Data Grid -->
            <div id="profileDataGrid" class="grid grid-cols-3 gap-4 hidden">
                <!-- Profile data options will be populated here -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-center gap-3 mt-10 pb-6">
            <button
                onclick="showPreview()"
                class="border border-gray-300 text-gray-700 font-dm text-sm font-medium px-5 py-2.5 rounded-full hover:bg-gray-50 transition-all flex items-center gap-2"
            >
                <i class="ph ph-eye text-base"></i>
                Preview
            </button>
            <button
                onclick="saveForm()"
                class="bg-gradient-to-r from-bermuda-orange to-bermuda-red text-white font-dm text-sm font-medium px-5 py-2.5 rounded-full hover:shadow-lg transition-all flex items-center gap-2"
            >
                <i class="ph ph-rocket-launch text-white text-base"></i>
                Save & Launch
            </button>
        </div>

        <!-- Loading/Success States -->
        <div id="loadingState" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-bermuda-orange mx-auto mb-4"></div>
                <p class="font-dm text-lg text-bermuda-text">Saving your form...</p>
            </div>
        </div>

        <!-- Launch Success Modal -->
        <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 text-center max-w-lg w-full mx-4">
                <!-- Success Message -->
                <div class="mb-4">
                    <h3 class="font-jakarta font-bold text-xl text-bermuda-text mb-2">Survey Ready to Share</h3>
                </div>

                <!-- Share Image -->
                <div class="mb-4">
                    <canvas id="shareGraphicCanvas" class="mx-auto rounded-lg border border-bermuda-border shadow-sm" width="320" height="200" style="max-width: 100%; height: auto;"></canvas>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-3">
                    <!-- Primary CTA -->
                    <button
                        onclick="copyShareLink()"
                        class="w-full bg-gradient-to-r from-bermuda-orange to-bermuda-red text-white px-4 py-3 rounded-lg hover:opacity-90 transition-opacity font-dm text-sm font-medium flex items-center justify-center gap-2"
                    >
                        <i class="ph ph-link text-white text-base"></i>
                        Copy Link
                    </button>

                    <!-- Secondary CTAs -->
                    <div class="flex gap-3">
                        <button
                            onclick="copyShareImage()"
                            class="flex-1 border border-bermuda-orange text-bermuda-orange px-4 py-2 rounded-lg hover:bg-bermuda-orange hover:text-white transition-all font-dm text-sm flex items-center justify-center gap-2"
                        >
                            <i class="ph ph-image text-current text-base"></i>
                            Copy Image
                        </button>
                        <button
                            onclick="downloadShareImage()"
                            class="flex-1 border border-gray-300 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-50 transition-all font-dm text-sm flex items-center justify-center gap-2"
                        >
                            <i class="ph ph-download-simple text-current text-base"></i>
                            Download
                        </button>
                    </div>

                    <!-- Navigation -->
                    <button
                        onclick="goToDashboard()"
                        class="w-full border border-gray-300 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-50 transition-all font-dm text-sm flex items-center justify-center gap-2"
                    >
                        <i class="ph ph-house text-current text-base"></i>
                        Go to Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Preview Modal -->
        <div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg w-full max-w-2xl max-h-screen overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="font-jakarta font-bold text-2xl text-bermuda-text">Form Preview</h3>
                        <button onclick="closePreview()" class="text-gray-400 hover:text-gray-600">
                            <i class="ph ph-x text-xl"></i>
                        </button>
                    </div>
                    <p class="text-sm text-bermuda-gray mt-2">This shows how respondents will experience your form as a conversation.</p>
                </div>

                <div class="p-6">
                    <!-- Mock Chat Interface -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-8 h-8 bg-bermuda-orange rounded-full flex items-center justify-center">
                                <i class="ph ph-chat-circle text-white"></i>
                            </div>
                            <div>
                                <div class="font-dm font-semibold text-bermuda-text">Barmuda Assistant</div>
                                <div class="text-xs text-bermuda-gray">AI Form Guide</div>
                            </div>
                        </div>

                        <div id="previewChat" class="space-y-4 max-h-96 overflow-y-auto">
                            <!-- Chat messages will be inserted here -->
                        </div>

                        <div class="mt-4 p-3 bg-white rounded-lg border border-gray-200">
                            <div class="text-sm text-bermuda-gray">This is a preview. In the actual form, respondents can type naturally here.</div>
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button
                            onclick="startPreview()"
                            class="bg-bermuda-orange text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity"
                        >
                            Start Preview
                        </button>
                        <button
                            onclick="closePreview()"
                            class="border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors"
                        >
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Back Confirmation Modal -->
        <div id="backConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg p-6 text-center max-w-sm w-full">
                <h3 class="font-jakarta font-bold text-lg text-bermuda-text mb-2">Leave without launching?</h3>
                <p class="text-sm text-bermuda-gray mb-6">Launching activates your form. Activate now or go back with the form inactive.</p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button
                        onclick="confirmActivateAndGoBack()"
                        class="flex-1 bg-gradient-to-r from-bermuda-orange to-bermuda-red text-white font-dm text-sm font-medium px-5 py-2.5 rounded-full hover:shadow-lg transition-all"
                    >
                        Activate &amp; Go Back
                    </button>
                    <button
                        onclick="confirmGoBackInactive()"
                        class="flex-1 border border-gray-300 text-gray-700 font-dm text-sm font-medium px-5 py-2.5 rounded-full hover:bg-gray-50 transition-all"
                    >
                        Go Back
                    </button>
                </div>
                <button onclick="cancelBackModal()" class="mt-4 text-sm text-gray-500 hover:text-gray-700">Stay on this page</button>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration & Scripts -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBk-JxeyA-e-H8lcV-INxZKRgMq3cyXGyQ",
            authDomain: "barmuda-in.firebaseapp.com",
            projectId: "barmuda-in",
            storageBucket: "barmuda-in.firebasestorage.app",
            messagingSenderId: "36564437421",
            appId: "1:36564437421:web:2a16afe9674a9d03333924"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Global variables
        let formData = null;
        let savedFormId = null;
        let backModalTarget = null;
        let currentFormMode = 'chat'; // Default to chat mode
        let selectedLanguageValue = '';
        let selectedVoiceValue = '';
        let selectedVoiceGender = '';

        // Demographics options
        const demographicsOptions = [
            'Age', 'Education', 'Experience', 'Income', 'Occupation', 'Weight',
            'Home city', 'Gender', 'Height'
        ];

        // Profile Data options with validation info
        const profileDataOptions = [
            { name: 'Name', key: 'name', validation: false },
            { name: 'Email Address', key: 'email', validation: true, tooltip: 'Basic email format validation (user@domain.com)' },
            { name: 'Phone Number', key: 'phone', validation: true, tooltip: 'Basic phone number format validation' },
            { name: 'Company', key: 'company', validation: false },
            { name: 'Job Title', key: 'jobtitle', validation: false },
            { name: 'LinkedIn Profile', key: 'linkedin', validation: true, tooltip: 'Basic LinkedIn URL validation (linkedin.com/in/username)' },
            { name: 'Website', key: 'website', validation: true, tooltip: 'Basic website URL validation (http/https)' },
            { name: 'Social Media Handle', key: 'socialmedia', validation: false }
        ];

        // Form mode selection functions
        function setFormMode(mode) {
            currentFormMode = mode;
            const chatBtn = document.getElementById('chatModeBtn');
            const voiceBtn = document.getElementById('voiceModeBtn');
            const voiceSettings = document.getElementById('voiceSettings');
            
            if (mode === 'chat') {
                chatBtn.classList.add('border-bermuda-orange', 'bg-bermuda-orange/5');
                chatBtn.classList.remove('border-gray-200', 'hover:border-bermuda-orange');
                chatBtn.querySelector('i').classList.add('text-bermuda-orange');
                chatBtn.querySelector('i').classList.remove('text-bermuda-gray');
                
                voiceBtn.classList.remove('border-bermuda-orange', 'bg-bermuda-orange/5');
                voiceBtn.classList.add('border-gray-200', 'hover:border-bermuda-orange');
                voiceBtn.querySelector('i').classList.remove('text-bermuda-orange');
                voiceBtn.querySelector('i').classList.add('text-bermuda-gray');
                
                voiceSettings.classList.add('hidden');
            } else {
                voiceBtn.classList.add('border-bermuda-orange', 'bg-bermuda-orange/5');
                voiceBtn.classList.remove('border-gray-200', 'hover:border-bermuda-orange');
                voiceBtn.querySelector('i').classList.add('text-bermuda-orange');
                voiceBtn.querySelector('i').classList.remove('text-bermuda-gray');
                
                chatBtn.classList.remove('border-bermuda-orange', 'bg-bermuda-orange/5');
                chatBtn.classList.add('border-gray-200', 'hover:border-bermuda-orange');
                chatBtn.querySelector('i').classList.remove('text-bermuda-orange');
                chatBtn.querySelector('i').classList.add('text-bermuda-gray');
                
                voiceSettings.classList.remove('hidden');
            }
            
            // Update formData
            if (formData) {
                formData.mode = mode;
                if (mode === 'voice') {
                    formData.voice_settings = getVoiceSettings();
                }
            }
        }
        
        function getVoiceSettings() {
            return {
                language: selectedLanguageValue || '',
                voice_id: selectedVoiceValue || '',
                voice_settings: {
                    stability: parseFloat(document.getElementById('stabilitySlider').value),
                    similarity_boost: parseFloat(document.getElementById('claritySlider').value),
                    style: parseFloat(document.getElementById('styleSlider').value),
                    use_speaker_boost: true
                }
            };
        }

        // Initialize form data from URL parameter, session storage, or existing form
        function initializeForm() {
            // Check for form ID in URL parameters first
            const urlParams = new URLSearchParams(window.location.search);
            const formIdFromUrl = urlParams.get('id');

            if (formIdFromUrl) {
                // Load form by ID from URL parameter (new inactive form)
                loadExistingForm(formIdFromUrl);
                return;
            }

            // Fallback to existing logic for backwards compatibility
            const storedForm = sessionStorage.getItem('generatedForm');
            const editFormId = sessionStorage.getItem('editFormId');

            if (editFormId) {
                // Load existing form for editing
                loadExistingForm(editFormId);
            } else if (storedForm) {
                // Load newly generated form (fallback)
                formData = JSON.parse(storedForm);
                populateForm();
                // Clear session storage since we're using it
                sessionStorage.removeItem('generatedForm');
            } else {
                // Redirect back if no form data
                window.location.href = '/create-form';
            }
        }

        // Load existing form from API
        async function loadExistingForm(formId) {
            try {
                const response = await authenticatedFetch(`/api/form/${formId}`);
                const data = await response.json();

                if (data.success) {
                    formData = data.form;
                    savedFormId = formId; // Set saved form ID for updates
                    populateForm();

                    // Update save button text based on form status
                    const saveBtn = document.querySelector('button[onclick="saveForm()"]');
                    if (saveBtn) {
                        if (data.form.active) {
                            // Already active form - update button
                            saveBtn.innerHTML = `
                                Update Form
                                <i class="ph ph-floppy-disk text-white text-xl"></i>
                            `;
                        } else {
                            // Inactive form - keep original "Save & Launch" button
                            saveBtn.innerHTML = `
                                Save & Launch
                                <i class="ph ph-floppy-disk text-white text-xl"></i>
                            `;
                        }
                    }
                } else {
                    alert('Failed to load form: ' + data.error);
                    window.location.href = '/dashboard';
                }
            } catch (error) {
                console.error('Error loading form:', error);
                alert('Failed to load form. Please try again.');
                window.location.href = '/dashboard';
            }
        }

        // Populate form with data
        function populateForm() {
            if (!formData) return;

            // Set title
            document.getElementById('formTitle').value = formData.title || '';

            // Set bot context
            document.getElementById('botContext').value = formData.bot_context || '';
            
            // Set form mode
            const mode = formData.mode || 'chat';
            setFormMode(mode);
            
            // Set voice settings if in voice mode
            if (mode === 'voice' && formData.voice_settings) {
                const settings = formData.voice_settings;
                if (settings.language) {
                    // Set language in custom dropdown
                    selectedLanguageValue = settings.language;
                    const selectedLanguageSpan = document.getElementById('selectedLanguage');
                    const langOption = document.querySelector(`[data-value="${settings.language}"]`);
                    if (langOption) {
                        selectedLanguageSpan.textContent = langOption.dataset.label;
                        selectedLanguageSpan.classList.remove('text-gray-500');
                        selectedLanguageSpan.classList.add('text-bermuda-text');
                        
                        // Populate and enable voice dropdown
                        populateVoiceDropdown(settings.language);
                        document.getElementById('voiceDropdownBtn').disabled = false;
                    }
                }
                if (settings.voice_id) {
                    // Set voice in custom dropdown
                    selectedVoiceValue = settings.voice_id;
                    const voices = voiceData[settings.language] || [];
                    const voice = voices.find(v => v.id === settings.voice_id);
                    if (voice) {
                        selectedVoiceGender = voice.gender;
                        const selectedVoiceSpan = document.getElementById('selectedVoice');
                        selectedVoiceSpan.textContent = `${voice.name} - ${voice.description}`;
                        selectedVoiceSpan.classList.remove('text-gray-500');
                        selectedVoiceSpan.classList.add('text-bermuda-text');
                        enableVoicePreview();
                    }
                }
                
                // Set voice modulation settings
                if (settings.voice_settings) {
                    const voiceModSettings = settings.voice_settings;
                    if (voiceModSettings.stability !== undefined) {
                        document.getElementById('stabilitySlider').value = voiceModSettings.stability;
                        document.getElementById('stabilityValue').textContent = voiceModSettings.stability;
                    }
                    if (voiceModSettings.similarity_boost !== undefined) {
                        document.getElementById('claritySlider').value = voiceModSettings.similarity_boost;
                        document.getElementById('clarityValue').textContent = voiceModSettings.similarity_boost;
                    }
                    if (voiceModSettings.style !== undefined) {
                        document.getElementById('styleSlider').value = voiceModSettings.style;
                        document.getElementById('styleValue').textContent = voiceModSettings.style;
                    }
                    if (voiceModSettings.use_speaker_boost !== undefined) {
                        document.getElementById('speakerBoostSlider').value = voiceModSettings.use_speaker_boost ? 1 : 0;
                        document.getElementById('speakerBoostValue').textContent = voiceModSettings.use_speaker_boost ? 'On' : 'Off';
                    }
                }
            }

            // Render questions
            renderQuestions();

            // Render demographics
            renderDemographics();

            // Render profile data
            renderProfileData();
        }

        // Render questions
        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            if (!formData.questions) return;

            formData.questions.forEach((question, index) => {
                const questionDiv = createQuestionElement(question, index);
                container.appendChild(questionDiv);

                // No separator needed with card design
            });
        }

        // Create question element
        function createQuestionElement(question, index) {
            const div = document.createElement('div');
            div.className = 'mb-6 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow p-4';
            div.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-jakarta font-semibold text-base ${question.enabled ? 'text-bermuda-text' : 'text-gray-400'}">
                        Question ${index + 1}
                    </h3>
                    <div class="flex items-center gap-2">
                        <button
                            onclick="deleteQuestion(${index})"
                            class="text-gray-400 hover:text-red-500 transition-colors p-1.5 rounded-md hover:bg-red-50"
                            title="Delete question"
                        >
                            <i class="ph ph-trash text-base"></i>
                        </button>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" ${question.enabled ? 'checked' : ''} onchange="toggleQuestion(${index})">
                            <div class="w-10 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-bermuda-orange/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-bermuda-orange shadow-inner"></div>
                        </label>
                    </div>
                </div>

                <!-- Question Text -->
                <div class="mb-3">
                    <input
                        type="text"
                        value="${question.text || ''}"
                        onchange="updateQuestionText(${index}, this.value)"
                        class="w-full font-dm text-sm text-bermuda-text bg-gray-50 rounded-lg px-3 py-2.5 outline-none focus:bg-white focus:ring-2 focus:ring-bermuda-orange/20 border border-transparent focus:border-bermuda-orange/30 transition-all placeholder:text-gray-400"
                        placeholder="Enter your question"
                    >
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <!-- Question Type -->
                    <div>
                        <label class="font-jakarta font-medium text-xs text-gray-600 mb-1.5 block">Question Type</label>
                        <div class="bg-gray-50 rounded-lg border border-gray-200 p-2.5 relative hover:border-gray-300 transition-colors">
                            <div class="custom-dropdown" id="dropdown-${index}">
                                <button
                                    onclick="toggleDropdown(${index})"
                                    class="w-full flex items-center justify-between font-dm text-sm text-bermuda-text bg-transparent outline-none"
                                >
                                    <span id="dropdown-selected-${index}">${getQuestionTypeLabel(question.type)}</span>
                                    <i class="ph ph-caret-down text-bermuda-gray transition-transform" id="dropdown-arrow-${index}"></i>
                                </button>
                                <div
                                    id="dropdown-options-${index}"
                                    class="hidden absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-md mt-1 shadow-lg z-10"
                                >
                                    <div onclick="selectQuestionType(${index}, 'text')" class="px-3 py-2 hover:bg-gray-50 cursor-pointer font-dm text-sm text-bermuda-text flex items-center gap-2">
                                        <i class="ph ph-text-aa text-bermuda-orange text-base"></i>
                                        <span>Text response</span>
                                    </div>
                                    <div onclick="selectQuestionType(${index}, 'multiple_choice')" class="px-4 py-3 hover:bg-gray-50 cursor-pointer font-dm text-base text-bermuda-text flex items-center gap-3">
                                        <i class="ph ph-list-bullets text-bermuda-orange text-xl"></i>
                                        <div>
                                            <div>Multiple Choice Question</div>
                                            <div class="text-xs text-bermuda-light-gray">Select from predefined options</div>
                                        </div>
                                    </div>
                                    <div onclick="selectQuestionType(${index}, 'yes_no')" class="px-4 py-3 hover:bg-gray-50 cursor-pointer font-dm text-base text-bermuda-text flex items-center gap-3">
                                        <i class="ph ph-check-circle text-bermuda-orange text-xl"></i>
                                        <div>
                                            <div>Yes / No</div>
                                            <div class="text-xs text-bermuda-light-gray">Simple binary choice</div>
                                        </div>
                                    </div>
                                    <div onclick="selectQuestionType(${index}, 'number')" class="px-4 py-3 hover:bg-gray-50 cursor-pointer font-dm text-base text-bermuda-text flex items-center gap-3">
                                        <i class="ph ph-hash text-bermuda-orange text-xl"></i>
                                        <div>
                                            <div>Number</div>
                                            <div class="text-xs text-bermuda-light-gray">Numeric values only</div>
                                        </div>
                                    </div>
                                    <div onclick="selectQuestionType(${index}, 'rating')" class="px-4 py-3 hover:bg-gray-50 cursor-pointer font-dm text-base text-bermuda-text border-b-0 flex items-center gap-3">
                                        <i class="ph ph-star text-bermuda-orange text-xl"></i>
                                        <div>
                                            <div>Rating</div>
                                            <div class="text-xs text-bermuda-light-gray">Scale-based evaluation</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Answer Options -->
                    <div>
                        <label class="font-jakarta font-medium text-xs text-gray-600 mb-1.5 block">Answer Options</label>
                        <div class="bg-gray-50 rounded-lg border border-gray-200 p-2.5 hover:border-gray-300 transition-colors">
                            ${getOptionsInput(question, index)}
                        </div>
                    </div>
                </div>
            `;

            return div;
        }

        // Get options input based on question type
        function getOptionsInput(question, index) {
            if (question.type === 'multiple_choice' || question.type === 'rating') {
                const options = question.options || [];
                return `
                    <div id="optionsContainer_${index}">
                        ${options.map((option, optIndex) => `
                            <div class="flex items-center gap-2 mb-2">
                                <input
                                    type="text"
                                    value="${option}"
                                    onchange="updateOption(${index}, ${optIndex}, this.value)"
                                    class="flex-1 font-dm text-base text-bermuda-text bg-transparent outline-none border-b border-gray-200 pb-1"
                                >
                                <button
                                    onclick="removeOption(${index}, ${optIndex})"
                                    class="text-red-500 hover:text-red-700 text-sm"
                                >
                                    ×
                                </button>
                            </div>
                        `).join('')}
                        <button
                            onclick="addOption(${index})"
                            class="text-bermuda-orange hover:text-bermuda-red text-sm font-dm"
                        >
                            + Add option
                        </button>
                    </div>
                `;
            } else {
                return '<span class="font-dm text-base text-bermuda-light-gray">none</span>';
            }
        }

        // Render demographics
        function renderDemographics() {
            const grid = document.getElementById('demographicsGrid');

            // Don't render items when demographics section is hidden
            if (grid.classList.contains('hidden')) {
                return;
            }

            grid.innerHTML = '';

            // Check if demographics section is enabled (main toggle state)
            const demographicsEnabled = !grid.classList.contains('hidden');

            demographicsOptions.forEach(option => {
                const isEnabled = demographicsEnabled && formData.demographics && formData.demographics[option.toLowerCase()] || false;

                const optionDiv = document.createElement('div');
                optionDiv.className = `bg-white rounded-md border border-gray-200 p-3 flex items-center justify-between hover:shadow-sm transition-shadow ${!demographicsEnabled ? 'opacity-50' : ''}`;
                optionDiv.innerHTML = `
                    <span class="font-dm text-base text-bermuda-text tracking-tight">${option}</span>
                    <label class="relative inline-flex items-center cursor-pointer ${!demographicsEnabled ? 'cursor-not-allowed' : ''}">
                        <input
                            type="checkbox"
                            class="sr-only peer"
                            ${isEnabled ? 'checked' : ''}
                            ${demographicsEnabled ? `onchange="toggleDemographic('${option.toLowerCase()}')"` : 'disabled'}
                        >
                        <div class="w-10 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-bermuda-orange/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-bermuda-orange shadow-inner ${!demographicsEnabled ? 'opacity-50' : ''}"></div>
                    </label>
                `;

                grid.appendChild(optionDiv);
            });
        }

        // Question manipulation functions
        function toggleQuestion(index) {
            if (formData.questions[index]) {
                formData.questions[index].enabled = !formData.questions[index].enabled;
                renderQuestions();
            }
        }

        function updateQuestionText(index, text) {
            if (formData.questions[index]) {
                formData.questions[index].text = text;
            }
        }

        function updateQuestionType(index, type) {
            if (formData.questions[index]) {
                formData.questions[index].type = type;

                // Reset options for new type
                if (type === 'multiple_choice') {
                    formData.questions[index].options = ['Option 1', 'Option 2'];
                } else if (type === 'rating') {
                    formData.questions[index].options = ['1', '2', '3', '4', '5'];
                } else {
                    formData.questions[index].options = null;
                }

                renderQuestions();
            }
        }

        // Custom dropdown functions
        function getQuestionTypeLabel(type) {
            const labels = {
                'text': '<i class="ph ph-text-aa text-bermuda-orange text-base mr-2"></i>Text response',
                'multiple_choice': '<i class="ph ph-list-bullets text-bermuda-orange text-base mr-2"></i>Multiple Choice Question',
                'yes_no': '<i class="ph ph-check-circle text-bermuda-orange text-base mr-2"></i>Yes / No',
                'number': '<i class="ph ph-hash text-bermuda-orange text-base mr-2"></i>Number',
                'rating': '<i class="ph ph-star text-bermuda-orange text-base mr-2"></i>Rating'
            };
            return labels[type] || '<i class="ph ph-text-aa text-bermuda-orange text-base mr-2"></i>Text response';
        }

        function toggleDropdown(index) {
            const optionsDiv = document.getElementById(`dropdown-options-${index}`);
            const arrow = document.getElementById(`dropdown-arrow-${index}`);

            // Close all other dropdowns first
            document.querySelectorAll('[id^="dropdown-options-"]').forEach(dropdown => {
                if (dropdown.id !== `dropdown-options-${index}`) {
                    dropdown.classList.add('hidden');
                    const arrowId = dropdown.id.replace('dropdown-options-', 'dropdown-arrow-');
                    const otherArrow = document.getElementById(arrowId);
                    if (otherArrow) otherArrow.classList.remove('rotate-180');
                }
            });

            // Toggle current dropdown
            optionsDiv.classList.toggle('hidden');
            arrow.classList.toggle('rotate-180');
        }

        function selectQuestionType(index, type) {
            // Update the display with HTML (to show icons)
            document.getElementById(`dropdown-selected-${index}`).innerHTML = getQuestionTypeLabel(type);

            // Close dropdown
            document.getElementById(`dropdown-options-${index}`).classList.add('hidden');
            document.getElementById(`dropdown-arrow-${index}`).classList.remove('rotate-180');

            // Update the question type
            updateQuestionType(index, type);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.custom-dropdown')) {
                document.querySelectorAll('[id^="dropdown-options-"]').forEach(dropdown => {
                    dropdown.classList.add('hidden');
                    const arrowId = dropdown.id.replace('dropdown-options-', 'dropdown-arrow-');
                    const arrow = document.getElementById(arrowId);
                    if (arrow) arrow.classList.remove('rotate-180');
                });
            }
        });

        function updateOption(questionIndex, optionIndex, value) {
            if (formData.questions[questionIndex] && formData.questions[questionIndex].options) {
                formData.questions[questionIndex].options[optionIndex] = value;
            }
        }

        function addOption(questionIndex) {
            if (formData.questions[questionIndex] && formData.questions[questionIndex].options) {
                formData.questions[questionIndex].options.push('New option');
                renderQuestions();
            }
        }

        function removeOption(questionIndex, optionIndex) {
            if (formData.questions[questionIndex] && formData.questions[questionIndex].options) {
                formData.questions[questionIndex].options.splice(optionIndex, 1);
                renderQuestions();
            }
        }

        function addQuestion() {
            const newQuestion = {
                text: 'New question',
                type: 'text',
                options: null,
                enabled: true
            };

            formData.questions.push(newQuestion);
            renderQuestions();
        }

        function deleteQuestion(index) {
            // Confirm deletion if the question has content
            const question = formData.questions[index];
            if (question && question.text && question.text.trim() !== '' && question.text.trim() !== 'New question') {
                if (!confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
                    return;
                }
            }

            // Remove the question from the array
            if (formData.questions && index >= 0 && index < formData.questions.length) {
                formData.questions.splice(index, 1);
                renderQuestions();
            }
        }

        // Demographics functions
        function toggleDemographics() {
            const grid = document.getElementById('demographicsGrid');
            const checkbox = document.getElementById('demographicsCheckbox');

            if (checkbox.checked) {
                // Show demographics section - enable it
                grid.classList.remove('hidden');

                // Initialize demographics if not set
                if (!formData.demographics) {
                    formData.demographics = {};
                    // Set all to false initially
                    demographicsOptions.forEach(opt => {
                        formData.demographics[opt.toLowerCase()] = false;
                    });
                }
            } else {
                // Hide demographics section - disable all demographics
                grid.classList.add('hidden');

                // Disable all demographics when hiding section
                if (!formData.demographics) formData.demographics = {};
                demographicsOptions.forEach(opt => {
                    formData.demographics[opt.toLowerCase()] = false;
                });
            }

            renderDemographics();
        }

        function toggleDemographic(option) {
            // Only allow toggling if demographics section is visible
            const grid = document.getElementById('demographicsGrid');
            if (grid.classList.contains('hidden')) {
                return;
            }

            if (!formData.demographics) {
                formData.demographics = {};
            }

            formData.demographics[option] = !formData.demographics[option];
            renderDemographics();
        }

        // Profile Data functions
        function renderProfileData() {
            const grid = document.getElementById('profileDataGrid');

            // Don't render items when profile data section is hidden
            if (grid.classList.contains('hidden')) {
                return;
            }

            grid.innerHTML = '';

            // Check if profile data section is enabled (main toggle state)
            const profileDataEnabled = !grid.classList.contains('hidden');

            profileDataOptions.forEach(option => {
                const isEnabled = profileDataEnabled && formData.profile_data && formData.profile_data[option.key] || false;

                const optionDiv = document.createElement('div');
                optionDiv.className = `bg-white rounded-lg border border-bermuda-border p-4 flex items-center justify-between ${!profileDataEnabled ? 'opacity-50' : ''}`;

                // Create the label section with optional shield icon
                let labelSection = `<span class="font-dm text-base text-bermuda-text tracking-tight">${option.name}</span>`;

                if (option.validation) {
                    labelSection = `
                        <div class="flex items-center gap-2">
                            <span class="font-dm text-base text-bermuda-text tracking-tight">${option.name}</span>
                            <div class="relative group">
                                <i class="ph ph-shield-check text-bermuda-orange text-sm opacity-70 hover:opacity-100 cursor-help"></i>
                                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-10">
                                    ${option.tooltip}
                                </div>
                            </div>
                        </div>
                    `;
                }

                optionDiv.innerHTML = `
                    <div class="flex items-center">
                        ${labelSection}
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer ${!profileDataEnabled ? 'cursor-not-allowed' : ''}">
                        <input
                            type="checkbox"
                            class="sr-only peer"
                            ${isEnabled ? 'checked' : ''}
                            ${profileDataEnabled ? `onchange="toggleProfileDataOption('${option.key}')"` : 'disabled'}
                        >
                        <div class="w-10 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-bermuda-orange/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-bermuda-orange shadow-inner ${!profileDataEnabled ? 'opacity-50' : ''}"></div>
                    </label>
                `;

                grid.appendChild(optionDiv);
            });
        }

        function toggleProfileData() {
            const grid = document.getElementById('profileDataGrid');
            const checkbox = document.getElementById('profileDataCheckbox');

            if (checkbox.checked) {
                // Show profile data section - enable it
                grid.classList.remove('hidden');

                // Initialize profile data if not set
                if (!formData.profile_data) {
                    formData.profile_data = {};
                    // Set all to false initially
                    profileDataOptions.forEach(opt => {
                        formData.profile_data[opt.key] = false;
                    });
                }
            } else {
                // Hide profile data section - disable all profile data
                grid.classList.add('hidden');

                // Disable all profile data when hiding section
                if (!formData.profile_data) formData.profile_data = {};
                profileDataOptions.forEach(opt => {
                    formData.profile_data[opt.key] = false;
                });
            }

            renderProfileData();
        }

        function toggleProfileDataOption(optionKey) {
            // Only allow toggling if profile data section is visible
            const grid = document.getElementById('profileDataGrid');
            if (grid.classList.contains('hidden')) {
                return;
            }

            if (!formData.profile_data) {
                formData.profile_data = {};
            }

            formData.profile_data[optionKey] = !formData.profile_data[optionKey];
            renderProfileData();
        }


        // Form validation
        function validateForm() {
            // Check title
            const title = document.getElementById('formTitle').value.trim();
            if (!title) {
                alert('Please enter a form title');
                return false;
            }

            // Check at least one enabled question
            const enabledQuestions = formData.questions.filter(q => q.enabled);
            if (enabledQuestions.length === 0) {
                alert('Please enable at least one question');
                return false;
            }

            // Check question texts
            for (let i = 0; i < formData.questions.length; i++) {
                const question = formData.questions[i];
                if (question.enabled && !question.text.trim()) {
                    alert(`Please enter text for question ${i + 1}`);
                    return false;
                }

                // Check options for multiple choice and rating
                if (question.enabled && (question.type === 'multiple_choice' || question.type === 'rating')) {
                    if (!question.options || question.options.length < 2) {
                        alert(`Please provide at least 2 options for question ${i + 1}`);
                        return false;
                    }
                }
            }

            return true;
        }

        // Save form
        async function saveForm(redirectUrl = null) {
            if (!validateForm()) return;

            // Update title and bot context
            formData.title = document.getElementById('formTitle').value.trim();
            formData.bot_context = document.getElementById('botContext').value.trim();
            
            // Update mode and voice settings
            formData.mode = currentFormMode;
            if (currentFormMode === 'voice') {
                formData.voice_settings = getVoiceSettings();
                // Validate voice settings
                if (!formData.voice_settings.language || !formData.voice_settings.voice_id) {
                    alert('Please select language and voice for voice mode');
                    return;
                }
            }

            const loadingState = document.getElementById('loadingState');
            loadingState.classList.remove('hidden');

            try {
                let response;

                if (savedFormId) {
                    // Update existing form and activate it
                    const updatedFormData = {
                        ...formData,
                        active: true,  // Activate the form
                        last_modified: new Date().toISOString()
                    };

                    response = await authenticatedFetch(`/api/update_form/${savedFormId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ form: updatedFormData })
                    });
                } else {
                    // Create new form (should rarely happen now)
                    const newFormData = {
                        ...formData,
                        active: true  // Activate immediately
                    };

                    response = await authenticatedFetch('/api/save_form', {
                        method: 'POST',
                        body: JSON.stringify({ form: newFormData })
                    });
                }

                const data = await response.json();

                if (data.success) {
                    savedFormId = data.form_id;
                    loadingState.classList.add('hidden');

                    // Generate share image and show modal or redirect
                    if (redirectUrl) {
                        sessionStorage.removeItem('generatedForm');
                        sessionStorage.removeItem('editFormId');
                        window.location.href = redirectUrl;
                    } else {
                        generateShareImage();
                        document.getElementById('successModal').classList.remove('hidden');

                        // Clear session storage after successful save
                        sessionStorage.removeItem('generatedForm');
                        sessionStorage.removeItem('editFormId');
                    }
                } else {
                    console.error('Save failed:', data.error);
                    alert('Failed to save form: ' + (data.error || 'Unknown error'));
                }

            } catch (error) {
                console.error('Save form error:', error);
                alert('Network error. Please try again.');
            } finally {
                loadingState.classList.add('hidden');
            }
        }

        // Navigation functions
        function handleNavigationAttempt(url) {
            if (!savedFormId) {
                backModalTarget = url;
                document.getElementById('backConfirmModal').classList.remove('hidden');
            } else {
                window.location.href = url;
            }
        }

        function goBack() {
            handleNavigationAttempt('/create-form');
        }

        function cancelBackModal() {
            document.getElementById('backConfirmModal').classList.add('hidden');
            backModalTarget = null;
            history.pushState(null, '', location.href);
        }

        async function confirmActivateAndGoBack() {
            document.getElementById('backConfirmModal').classList.add('hidden');
            await saveForm(backModalTarget || '/dashboard');
        }

        function confirmGoBackInactive() {
            window.location.href = backModalTarget || '/dashboard';
        }

        function goToDashboard() {
            window.location.href = '/dashboard';
        }

        function copyShareLink() {
            if (savedFormId) {
                const link = `${window.location.origin}/form/${savedFormId}`;
                navigator.clipboard.writeText(link).then(() => {
                    alert('Link copied to clipboard!');
                }).catch(() => {
                    // Fallback for older browsers
                    prompt('Copy this link:', link);
                });
            }
        }

        // Generate fancy, attractive share image
        function generateShareImage() {
            const canvas = document.getElementById('shareGraphicCanvas');
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;

            // High-DPI setup
            canvas.width = 320 * dpr;
            canvas.height = 200 * dpr;
            ctx.scale(dpr, dpr);

            // Fancy gradient background with multiple stops
            const gradient = ctx.createLinearGradient(0, 0, 320, 200);
            gradient.addColorStop(0, '#cc5500');
            gradient.addColorStop(0.5, '#d12b2e');
            gradient.addColorStop(1, '#b8441f');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 320, 200);

            // Add subtle pattern overlay for texture
            ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
            for (let i = 0; i < 320; i += 15) {
                for (let j = 0; j < 200; j += 15) {
                    if ((i + j) % 30 === 0) {
                        ctx.fillRect(i, j, 1, 1);
                    }
                }
            }

            // Elegant content card with shadow effect
            ctx.shadowColor = 'rgba(0, 0, 0, 0.15)';
            ctx.shadowBlur = 8;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 2;

            ctx.fillStyle = 'rgba(255, 255, 255, 0.98)';
            ctx.roundRect(15, 25, 290, 150, 12);
            ctx.fill();

            // Reset shadow
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;

            // Logo placeholder in top right (small B icon for now)
            ctx.fillStyle = '#cc5500';
            ctx.font = 'bold 12px "Plus Jakarta Sans", Arial, sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText('B', 295, 45);

            // Form title with proper typography and spacing
            ctx.fillStyle = '#1e1e1e';
            ctx.font = 'bold 20px "Plus Jakarta Sans", Arial, sans-serif';
            ctx.textAlign = 'center';
            const title = formData.title || 'Survey';
            const maxWidth = 250;
            const words = title.split(' ');
            let line = '';
            let y = 85;
            const lineHeight = 26; // Better line spacing

            for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                    ctx.fillText(line.trim(), 160, y);
                    line = words[n] + ' ';
                    y += lineHeight;
                    if (y > 115) break; // Max 2 lines with better spacing
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line.trim(), 160, y);

            // Attractive call to action with accent color and proper spacing
            ctx.fillStyle = '#cc5500';
            ctx.font = '15px "DM Sans", Arial, sans-serif';
            ctx.fillText('Quick 2-minute chat', 160, y + 32);

            // Subtle domain branding
            ctx.fillStyle = '#999';
            ctx.font = '11px "DM Sans", Arial, sans-serif';
            ctx.fillText('barmuda.in', 160, 165);

            // Add decorative element - small dots for visual interest
            ctx.fillStyle = 'rgba(204, 85, 0, 0.2)';
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.arc(130 + (i * 20), y + 45, 2, 0, 2 * Math.PI);
                ctx.fill();
            }
        }

        // Canvas rounded rectangle helper
        CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            this.beginPath();
            this.moveTo(x+r, y);
            this.arcTo(x+w, y, x+w, y+h, r);
            this.arcTo(x+w, y+h, x, y+h, r);
            this.arcTo(x, y+h, x, y, r);
            this.arcTo(x, y, x+w, y, r);
            this.closePath();
            return this;
        }

        // Copy share image to clipboard
        async function copyShareImage() {
            try {
                const canvas = document.getElementById('shareGraphicCanvas');
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        alert('Image copied to clipboard!');
                    } catch (err) {
                        alert('Copy failed. Try download instead.');
                    }
                }, 'image/png');
            } catch (error) {
                alert('Copy not supported. Try download instead.');
            }
        }

        // Download share image
        function downloadShareImage() {
            const canvas = document.getElementById('shareGraphicCanvas');
            const link = document.createElement('a');
            const title = formData.title || 'Survey';
            const filename = title.replace(/[^a-z0-9]/gi, '_').toLowerCase();

            link.download = `${filename}_share.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            alert('Image downloaded!');
        }

        // Preview functionality
        function showPreview() {
            if (!validateForm()) return;

            // Update title and bot context
            formData.title = document.getElementById('formTitle').value.trim();
            formData.bot_context = document.getElementById('botContext').value.trim();

            document.getElementById('previewModal').classList.remove('hidden');
        }

        function closePreview() {
            document.getElementById('previewModal').classList.add('hidden');
        }

        function startPreview() {
            const chatContainer = document.getElementById('previewChat');
            chatContainer.innerHTML = '';

            // Start the preview simulation
            simulateConversation();
        }

        function simulateConversation() {
            const chatContainer = document.getElementById('previewChat');
            const enabledQuestions = formData.questions.filter(q => q.enabled);

            // Welcome message
            addChatMessage('assistant', `Hi! I'm here to help you with "${formData.title}". Let's get started! This should only take a few minutes.`);

            let currentQuestionIndex = 0;

            function showNextQuestion() {
                if (currentQuestionIndex >= enabledQuestions.length) {
                    // Show demographics if enabled
                    const enabledDemographics = Object.keys(formData.demographics || {}).filter(key => formData.demographics[key]);
                    const enabledProfileData = Object.keys(formData.profile_data || {}).filter(key => formData.profile_data[key]);

                    if (enabledDemographics.length > 0 || enabledProfileData.length > 0) {
                        setTimeout(() => {
                            let additionalQuestions = [];
                            if (enabledDemographics.length > 0) {
                                additionalQuestions.push(`demographic questions (${enabledDemographics.join(', ')})`);
                            }
                            if (enabledProfileData.length > 0) {
                                additionalQuestions.push(`profile information (${enabledProfileData.join(', ')})`);
                            }

                            addChatMessage('assistant', `Great! Just a few quick additional questions to wrap up: ${additionalQuestions.join(' and ')}.`);
                            setTimeout(() => {
                                addChatMessage('user', '[User provides demographic and profile information...]', true);
                                setTimeout(() => {
                                    addChatMessage('assistant', 'Perfect! Thank you for completing the form. Your responses have been recorded.');
                                }, 1500);
                            }, 1000);
                        }, 1000);
                    } else {
                        setTimeout(() => {
                            addChatMessage('assistant', 'Perfect! Thank you for completing the form. Your responses have been recorded.');
                        }, 1000);
                    }
                    return;
                }

                const question = enabledQuestions[currentQuestionIndex];

                setTimeout(() => {
                    addChatMessage('assistant', question.text);

                    // Show sample user response based on question type
                    setTimeout(() => {
                        let sampleResponse = getSampleResponse(question);
                        addChatMessage('user', sampleResponse, true);

                        currentQuestionIndex++;
                        showNextQuestion();
                    }, 1500);
                }, 1000);
            }

            // Start showing questions
            setTimeout(showNextQuestion, 1000);
        }

        function getSampleResponse(question) {
            switch (question.type) {
                case 'multiple_choice':
                    return question.options && question.options.length > 0 ? question.options[0] : 'Option 1';
                case 'yes_no':
                    return 'Yes';
                case 'rating':
                    return '4';
                case 'number':
                    return '25';
                case 'text':
                default:
                    return 'This is a sample text response that shows how users might naturally answer this question.';
            }
        }

        function addChatMessage(sender, message, isUser = false) {
            const chatContainer = document.getElementById('previewChat');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

            messageDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isUser ? 'bg-bermuda-orange text-white' : 'bg-white border border-gray-200'}">
                    <p class="text-sm ${isUser ? 'text-white' : 'text-bermuda-text'}">${message}</p>
                </div>
            `;

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Authentication functions
        async function signOut() {
            try {
                await auth.signOut();
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/';
            } catch (error) {
                console.error('Sign out error:', error);
                alert('Failed to sign out');
            }
        }

        // Helper function for authenticated requests (session-based)
        async function authenticatedFetch(url, options = {}) {
            return fetch(url, {
                ...options,
                credentials: 'include',
                headers: {
                    ...options.headers,
                    'Content-Type': 'application/json',
                }
            });
        }

        // Initialize form on page load (Flask handles auth at route level)
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            history.pushState(null, '', location.href);

            // Intercept dashboard navigation
            document.querySelectorAll('a[href="/dashboard"]').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    handleNavigationAttempt('/dashboard');
                });
            });

            // Handle browser back button
            window.addEventListener('popstate', function() {
                handleNavigationAttempt(document.referrer || '/dashboard');
                history.pushState(null, '', location.href);
            });

            // Comprehensive voice data with language filtering and gender info
            const voiceData = {
                'en': [
                    {id: '21m00Tcm4TlvDq8ikWAM', name: 'Rachel', description: 'Calm & Professional', gender: 'female'},
                    {id: 'AZnzlk1XvdvUeBnXmlld', name: 'Domi', description: 'Strong & Confident', gender: 'female'},
                    {id: 'EXAVITQu4vr4xnSDxMaL', name: 'Bella', description: 'Sweet & Narration', gender: 'female'},
                    {id: 'ErXwobaYiN019PkySvjV', name: 'Antoni', description: 'Well-rounded & Versatile', gender: 'male'},
                    {id: 'MF3mGyEYCl7XYWbV9V6O', name: 'Elli', description: 'Emotional & Expressive', gender: 'female'},
                    {id: 'TxGEqnHWrfWFTfGW9XjX', name: 'Josh', description: 'Deep & Authoritative', gender: 'male'},
                    {id: 'VR6AewLTigWG4xSOukaG', name: 'Arnold', description: 'Crisp & Clear', gender: 'male'},
                    {id: 'pNInz6obpgDQGcFmaJgB', name: 'Adam', description: 'Deep & Narrative', gender: 'male'},
                    {id: 'yoZ06aMxZJJ28mfd3POQ', name: 'Sam', description: 'Raspy & Casual', gender: 'male'},
                    {id: 'XrExE9yKIg1WjnnlVkGX', name: 'Matilda', description: 'Warm & Friendly', gender: 'female'},
                    {id: 'cgSgspJ2msm6clMCkdW9', name: 'Jessica', description: 'Professional & Clear', gender: 'female'},
                    {id: 'FGY2WhTYpPnrIDTdsKH5', name: 'Laura', description: 'Upbeat & Energetic', gender: 'female'}
                ],
                'en-GB': [
                    {id: 'N2lVS1w4EtoT3dr4eOWO', name: 'Callum', description: 'British & Intense', gender: 'male'},
                    {id: 'XrExE9yKIg1WjnnlVkGX', name: 'Matilda', description: 'British & Warm', gender: 'female'},
                    {id: 'cgSgspJ2msm6clMCkdW9', name: 'Jessica', description: 'British & Professional', gender: 'female'}
                ],
                'en-AU': [
                    {id: 'VR6AewLTigWG4xSOukaG', name: 'Arnold', description: 'Australian & Crisp', gender: 'male'},
                    {id: 'EXAVITQu4vr4xnSDxMaL', name: 'Bella', description: 'Australian & Sweet', gender: 'female'}
                ],
                'en-IN': [
                    {id: 'pNInz6obpgDQGcFmaJgB', name: 'Arjun', description: 'Indian English & Professional', gender: 'male'},
                    {id: 'cgSgspJ2msm6clMCkdW9', name: 'Priya', description: 'Indian English & Warm', gender: 'female'},
                    {id: 'XrExE9yKIg1WjnnlVkGX', name: 'Ananya', description: 'Indian English & Friendly', gender: 'female'}
                ],
                'es': [
                    {id: 'ThT5KcBeYPX3keUQqHPh', name: 'Diego', description: 'Professional & Clear', gender: 'male'},
                    {id: 'XB0fDUnXU5powFXDhCwa', name: 'Charlotte', description: 'Warm & Expressive', gender: 'female'},
                    {id: 'bVMeCyTHy58xNoL34h3p', name: 'Valentina', description: 'Elegant & Sophisticated', gender: 'female'}
                ],
                'es-MX': [
                    {id: 'ThT5KcBeYPX3keUQqHPh', name: 'Carlos', description: 'Mexican & Friendly', gender: 'male'},
                    {id: 'XB0fDUnXU5powFXDhCwa', name: 'Sofia', description: 'Mexican & Warm', gender: 'female'}
                ],
                'fr': [
                    {id: 'XrExE9yKIg1WjnnlVkGX', name: 'Mathilde', description: 'French & Elegant', gender: 'female'},
                    {id: 'ErXwobaYiN019PkySvjV', name: 'Antoine', description: 'French & Professional', gender: 'male'}
                ],
                'de': [
                    {id: 'N2lVS1w4EtoT3dr4eOWO', name: 'Klaus', description: 'German & Authoritative', gender: 'male'},
                    {id: 'EXAVITQu4vr4xnSDxMaL', name: 'Greta', description: 'German & Clear', gender: 'female'}
                ],
                'it': [
                    {id: 'AZnzlk1XvdvUeBnXmlld', name: 'Marco', description: 'Italian & Expressive', gender: 'male'},
                    {id: 'MF3mGyEYCl7XYWbV9V6O', name: 'Giulia', description: 'Italian & Melodic', gender: 'female'}
                ],
                'pt': [
                    {id: 'ErXwobaYiN019PkySvjV', name: 'António', description: 'Portuguese & Professional', gender: 'male'},
                    {id: 'EXAVITQu4vr4xnSDxMaL', name: 'Beatriz', description: 'Portuguese & Warm', gender: 'female'}
                ],
                'pt-BR': [
                    {id: 'ErXwobaYiN019PkySvjV', name: 'Roberto', description: 'Brazilian & Friendly', gender: 'male'},
                    {id: 'EXAVITQu4vr4xnSDxMaL', name: 'Fernanda', description: 'Brazilian & Lively', gender: 'female'}
                ],
                'hi': [
                    {id: 'pNInz6obpgDQGcFmaJgB', name: 'राज (Raj)', description: 'Hindi & Professional', gender: 'male'},
                    {id: 'cgSgspJ2msm6clMCkdW9', name: 'प्रिया (Priya)', description: 'Hindi & Gentle', gender: 'female'},
                    {id: 'XrExE9yKIg1WjnnlVkGX', name: 'अर्जुन (Arjun)', description: 'Hindi & Confident', gender: 'male'},
                    {id: 'EXAVITQu4vr4xnSDxMaL', name: 'सुनीता (Sunita)', description: 'Hindi & Melodious', gender: 'female'}
                ],
                'ja': [
                    {id: 'ErXwobaYiN019PkySvjV', name: 'Takeshi', description: 'Japanese & Professional', gender: 'male'},
                    {id: 'EXAVITQu4vr4xnSDxMaL', name: 'Yuki', description: 'Japanese & Gentle', gender: 'female'}
                ],
                'ko': [
                    {id: 'pNInz6obpgDQGcFmaJgB', name: 'Min-jun', description: 'Korean & Clear', gender: 'male'},
                    {id: 'cgSgspJ2msm6clMCkdW9', name: 'So-young', description: 'Korean & Friendly', gender: 'female'}
                ],
                'zh': [
                    {id: 'ErXwobaYiN019PkySvjV', name: 'Li Wei', description: 'Chinese & Professional', gender: 'male'},
                    {id: 'EXAVITQu4vr4xnSDxMaL', name: 'Mei Lin', description: 'Chinese & Gentle', gender: 'female'}
                ],
                'ar': [
                    {id: 'pNInz6obpgDQGcFmaJgB', name: 'Omar', description: 'Arabic & Clear', gender: 'male'},
                    {id: 'cgSgspJ2msm6clMCkdW9', name: 'Fatima', description: 'Arabic & Elegant', gender: 'female'}
                ],
                'ru': [
                    {id: 'ErXwobaYiN019PkySvjV', name: 'Alexei', description: 'Russian & Authoritative', gender: 'male'},
                    {id: 'EXAVITQu4vr4xnSDxMaL', name: 'Natasha', description: 'Russian & Expressive', gender: 'female'}
                ]
            };

            // Global variables for selected values

            // Custom dropdown functionality
            function initializeCustomDropdowns() {
                // Language dropdown
                const languageBtn = document.getElementById('languageDropdownBtn');
                const languageDropdown = document.getElementById('languageDropdown');
                const selectedLanguageSpan = document.getElementById('selectedLanguage');
                const voiceBtn = document.getElementById('voiceDropdownBtn');
                const selectedVoiceSpan = document.getElementById('selectedVoice');

                // Toggle language dropdown
                languageBtn.addEventListener('click', () => {
                    languageDropdown.classList.toggle('hidden');
                    // Close voice dropdown if open
                    document.getElementById('voiceDropdown').classList.add('hidden');
                });

                // Language selection
                languageDropdown.addEventListener('click', (e) => {
                    if (e.target.dataset.value) {
                        selectedLanguageValue = e.target.dataset.value;
                        selectedLanguageSpan.textContent = e.target.dataset.label;
                        selectedLanguageSpan.classList.remove('text-gray-500');
                        selectedLanguageSpan.classList.add('text-bermuda-text');
                        languageDropdown.classList.add('hidden');
                        
                        // Enable voice dropdown and populate voices
                        populateVoiceDropdown(selectedLanguageValue);
                        voiceBtn.disabled = false;
                        selectedVoiceSpan.textContent = 'Select Voice';
                        selectedVoiceSpan.classList.add('text-gray-500');
                        selectedVoiceSpan.classList.remove('text-bermuda-text');
                        selectedVoiceValue = '';
                        selectedVoiceGender = '';
                        
                        // Disable preview until voice is selected
                        enableVoicePreview();
                    }
                });

                // Voice dropdown
                const voiceDropdownEl = document.getElementById('voiceDropdown');
                voiceBtn.addEventListener('click', () => {
                    if (!voiceBtn.disabled) {
                        voiceDropdownEl.classList.toggle('hidden');
                        // Close language dropdown if open
                        languageDropdown.classList.add('hidden');
                    }
                });

                // Voice selection
                voiceDropdownEl.addEventListener('click', (e) => {
                    if (e.target.dataset.value) {
                        selectedVoiceValue = e.target.dataset.value;
                        selectedVoiceGender = e.target.dataset.gender;
                        selectedVoiceSpan.textContent = e.target.dataset.label;
                        selectedVoiceSpan.classList.remove('text-gray-500');
                        selectedVoiceSpan.classList.add('text-bermuda-text');
                        voiceDropdownEl.classList.add('hidden');
                        
                        // Enable preview
                        enableVoicePreview();
                    }
                });

                // Close dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    if (!languageBtn.contains(e.target) && !languageDropdown.contains(e.target)) {
                        languageDropdown.classList.add('hidden');
                    }
                    if (!voiceBtn.contains(e.target) && !voiceDropdownEl.contains(e.target)) {
                        voiceDropdownEl.classList.add('hidden');
                    }
                });
            }

            function populateVoiceDropdown(language) {
                const voiceOptions = document.getElementById('voiceOptions');
                const voices = voiceData[language] || [];
                
                voiceOptions.innerHTML = '';
                
                if (voices.length === 0) {
                    voiceOptions.innerHTML = '<div class="px-3 py-2 text-gray-400 text-sm">No voices available</div>';
                    return;
                }
                
                voices.forEach(voice => {
                    const option = document.createElement('div');
                    option.className = 'px-3 py-2 hover:bg-gray-50 rounded cursor-pointer text-sm flex items-center justify-between';
                    option.dataset.value = voice.id;
                    option.dataset.label = `${voice.name} - ${voice.description}`;
                    option.dataset.gender = voice.gender;
                    
                    option.innerHTML = `
                        <div>
                            <div class="font-medium text-bermuda-text">${voice.name}</div>
                            <div class="text-xs text-gray-500">${voice.description}</div>
                        </div>
                        <div class="text-xs px-2 py-1 rounded ${voice.gender === 'female' ? 'bg-pink-100 text-pink-600' : 'bg-blue-100 text-blue-600'}">
                            ${voice.gender === 'female' ? '👩' : '👨'} ${voice.gender}
                        </div>
                    `;
                    
                    voiceOptions.appendChild(option);
                });
            }

            // Voice modulation sliders
            function initializeVoiceModulation() {
                const stabilitySlider = document.getElementById('stabilitySlider');
                const claritySlider = document.getElementById('claritySlider');
                const styleSlider = document.getElementById('styleSlider');
                
                const stabilityValue = document.getElementById('stabilityValue');
                const clarityValue = document.getElementById('clarityValue');
                const styleValue = document.getElementById('styleValue');

                stabilitySlider.addEventListener('input', (e) => {
                    stabilityValue.textContent = e.target.value;
                });

                claritySlider.addEventListener('input', (e) => {
                    clarityValue.textContent = e.target.value;
                });

                styleSlider.addEventListener('input', (e) => {
                    styleValue.textContent = e.target.value;
                });
            }

            // Voice Preview Functionality
            function enableVoicePreview() {
                const previewBtn = document.getElementById('previewVoiceBtn');
                const previewText = document.getElementById('previewText');
                
                if (selectedVoiceValue) {
                    previewBtn.disabled = false;
                    previewText.textContent = 'Click to hear a sample of this voice';
                } else {
                    previewBtn.disabled = true;
                    previewText.textContent = 'Select a voice to hear a preview';
                }
            }

            // Voice preview event listener
            document.getElementById('previewVoiceBtn').addEventListener('click', async function() {
                if (!selectedVoiceValue) {
                    alert('Please select a voice first');
                    return;
                }

                const btn = this;
                const icon = btn.querySelector('i');
                const originalText = btn.innerHTML;
                
                // Update button state
                btn.disabled = true;
                icon.className = 'ph ph-spinner-gap text-white animate-spin';
                btn.innerHTML = icon.outerHTML + ' Playing...';
                
                try {
                    // Gender-appropriate preview text
                    const genderPreviewTexts = {
                        'en': {
                            'female': 'Hello! I\'m here to help you with your survey. I sound natural and friendly.',
                            'male': 'Hello! I\'m here to help you with your survey. I sound professional and clear.'
                        },
                        'es': {
                            'female': 'Hola! Estoy aquí para ayudarte con tu encuesta. Sueno natural y amigable.',
                            'male': 'Hola! Estoy aquí para ayudarte con tu encuesta. Sueno profesional y claro.'
                        },
                        'fr': {
                            'female': 'Bonjour! Je suis ici pour vous aider avec votre sondage. Je sonne naturelle et amicale.',
                            'male': 'Bonjour! Je suis ici pour vous aider avec votre sondage. Je sonne professionnel et clair.'
                        },
                        'de': {
                            'female': 'Hallo! Ich bin hier, um Ihnen bei Ihrer Umfrage zu helfen. Ich klinge natürlich und freundlich.',
                            'male': 'Hallo! Ich bin hier, um Ihnen bei Ihrer Umfrage zu helfen. Ich klinge professionell und klar.'
                        },
                        'hi': {
                            'female': 'नमस्ते! मैं आपके सर्वेक्षण में आपकी सहायता के लिए यहाँ हूँ। मैं प्राकृतिक और मित्रवत लगती हूँ।',
                            'male': 'नमस्ते! मैं आपके सर्वेक्षण में आपकी सहायता के लिए यहाँ हूँ। मैं व्यावसायिक और स्पष्ट लगता हूँ।'
                        },
                        'it': {
                            'female': 'Ciao! Sono qui per aiutarti con il tuo sondaggio. Suono naturale e amichevole.',
                            'male': 'Ciao! Sono qui per aiutarti con il tuo sondaggio. Suono professionale e chiaro.'
                        },
                        'pt': {
                            'female': 'Olá! Estou aqui para ajudá-la com sua pesquisa. Eu soou natural e amigável.',
                            'male': 'Olá! Estou aqui para ajudá-lo com sua pesquisa. Eu soou profissional e claro.'
                        },
                        'ja': {
                            'female': 'こんにちは！アンケートのお手伝いをします。自然で親しみやすく聞こえます。',
                            'male': 'こんにちは！アンケートのお手伝いをします。プロフェッショナルで明確に聞こえます。'
                        },
                        'ko': {
                            'female': '안녕하세요! 설문조사를 도와드리겠습니다. 자연스럽고 친근하게 들립니다.',
                            'male': '안녕하세요! 설문조사를 도와드리겠습니다. 전문적이고 명확하게 들립니다.'
                        }
                    };
                    
                    const langCode = selectedLanguageValue.split('-')[0]; // Get base language
                    const genderTexts = genderPreviewTexts[langCode] || genderPreviewTexts['en'];
                    const text = genderTexts[selectedVoiceGender] || genderTexts['female'] || 'Hello! This is a preview of my voice.';
                    
                    // Get voice modulation settings
                    const voiceSettings = {
                        stability: parseFloat(document.getElementById('stabilitySlider').value),
                        similarity_boost: parseFloat(document.getElementById('claritySlider').value),
                        style: parseFloat(document.getElementById('styleSlider').value),
                        use_speaker_boost: true
                    };
                    
                    // Call ElevenLabs TTS API
                    const response = await fetch('/api/voice/preview', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            voice_id: selectedVoiceValue,
                            text: text,
                            voice_settings: voiceSettings
                        })
                    });

                    if (response.ok) {
                        const audioBlob = await response.blob();
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        
                        audio.onended = () => {
                            URL.revokeObjectURL(audioUrl);
                            // Reset button state
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                        };
                        
                        audio.onerror = () => {
                            URL.revokeObjectURL(audioUrl);
                            // Reset button state
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                            alert('Error playing voice preview');
                        };
                        
                        await audio.play();
                    } else {
                        throw new Error('Failed to generate voice preview');
                    }
                    
                } catch (error) {
                    console.error('Voice preview error:', error);
                    alert('Unable to play voice preview. Please try again.');
                    // Reset button state
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });

            // Initialize voice functionality
            initializeCustomDropdowns();
            initializeVoiceModulation();
        });
    </script>

    {% include 'partials/footer.html' %}
</body>
</html>
