<!DOCTYPE html>
<html>
<head>
    <title>Production Title Fix Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh; }
        .container { max-width: 600px; margin: 0 auto; }
        .test { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 20px; margin: 15px 0; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); }
        .success { background: rgba(40, 167, 69, 0.2); border-color: #28a745; }
        .error { background: rgba(220, 53, 69, 0.2); border-color: #dc3545; }
        .loading { background: rgba(255, 193, 7, 0.2); border-color: #ffc107; }
        button { background: #cc5500; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 10px 5px 0 0; }
        button:hover { background: #b84600; }
        pre { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Production Survey Title Fix Test</h1>
        
        <div id="api-test" class="test loading">
            <h3>1. API Endpoint Test</h3>
            <p id="api-result">Testing production API...</p>
            <button onclick="testAPI()">Retry API Test</button>
        </div>
        
        <div class="test">
            <h3>2. Widget Integration Test</h3>
            <p>The widget should load from production (barmuda.in) and display the correct survey title.</p>
            <p><strong>Expected:</strong> Title should show "Customer Feedback Survey"</p>
            <p><strong>Not:</strong> "Loading..." or "Survey"</p>
        </div>
        
        <div id="widget-test" class="test loading">
            <h3>3. Widget Status</h3>
            <p id="widget-result">Loading widget from production...</p>
            <button onclick="openWidget()" id="open-btn" disabled>Open Widget</button>
            <button onclick="checkTitle()" id="check-btn" disabled>Check Title</button>
        </div>

        <div id="log-test" class="test">
            <h3>4. Console Logs</h3>
            <pre id="console-log">Loading...</pre>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <script>
        const logs = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logs.push(logEntry);
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            document.getElementById('console-log').textContent = logs.slice(-15).join('\n');
        }
        
        function clearLogs() {
            logs.length = 0;
            updateLogDisplay();
        }
        
        // Override console methods
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'info');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog(args.join(' '), 'error');
        };
        
        function testAPI() {
            const apiDiv = document.getElementById('api-test');
            const resultDiv = document.getElementById('api-result');
            
            apiDiv.className = 'test loading';
            resultDiv.innerHTML = 'Testing API endpoint...';
            addLog('Testing production API endpoint');
            
            fetch('https://barmuda.in/api/form/5fjcRD3YcYkK5o3LIDyT/public')
                .then(response => {
                    addLog(`API response status: ${response.status}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    addLog('API response received', 'success');
                    addLog(JSON.stringify(data, null, 2));
                    
                    if (data.success && data.form && data.form.title) {
                        resultDiv.innerHTML = `‚úÖ <strong>SUCCESS!</strong><br>API returns: "${data.form.title}"`;
                        apiDiv.className = 'test success';
                        addLog(`Form title from API: "${data.form.title}"`, 'success');
                    } else {
                        resultDiv.innerHTML = `‚ùå <strong>API Error:</strong><br>Unexpected response format`;
                        apiDiv.className = 'test error';
                        addLog('API response format error', 'error');
                    }
                })
                .catch(error => {
                    resultDiv.innerHTML = `‚ùå <strong>Failed:</strong><br>${error.message}<br><small>Check if deployment is complete</small>`;
                    apiDiv.className = 'test error';
                    addLog(`API error: ${error.message}`, 'error');
                });
        }
        
        function openWidget() {
            if (window.BarmudaWidget) {
                addLog('Opening widget manually');
                window.BarmudaWidget.open();
                setTimeout(checkTitle, 2000);
            } else {
                addLog('BarmudaWidget not available', 'error');
            }
        }
        
        function checkTitle() {
            const titleElement = document.querySelector('.barmuda-form-title');
            if (titleElement) {
                const titleText = titleElement.textContent;
                addLog(`Widget title found: "${titleText}"`);
                
                if (titleText === 'Customer Feedback Survey') {
                    addLog('üéâ TITLE FIX SUCCESSFUL!', 'success');
                    document.getElementById('widget-test').className = 'test success';
                    document.getElementById('widget-result').innerHTML = '‚úÖ <strong>SUCCESS!</strong><br>Survey title loads correctly!';
                } else if (titleText === 'Loading...') {
                    addLog('Title still loading - try again in a moment', 'info');
                } else {
                    addLog(`Title shows unexpected text: "${titleText}"`, 'error');
                }
            } else {
                addLog('Title element not found - widget may not be open', 'error');
            }
        }
        
        // Load production widget
        addLog('Loading widget script from production');
        const script = document.createElement('script');
        script.src = 'https://barmuda.in/widget.js?v=' + Date.now();
        script.setAttribute('data-form-id', '5fjcRD3YcYkK5o3LIDyT');
        script.setAttribute('data-position', 'bottom-right');
        script.setAttribute('data-color', '#cc5500');
        
        script.onload = function() {
            addLog('Widget script loaded successfully', 'success');
            
            setTimeout(() => {
                const fab = document.getElementById('barmuda-fab');
                if (fab) {
                    addLog('Widget FAB button created', 'success');
                    document.getElementById('widget-result').innerHTML = '‚úÖ Widget loaded! Click button below to test.';
                    document.getElementById('widget-test').className = 'test success';
                    document.getElementById('open-btn').disabled = false;
                    document.getElementById('check-btn').disabled = false;
                } else {
                    addLog('Widget FAB button not found', 'error');
                    document.getElementById('widget-result').innerHTML = '‚ùå Widget failed to load properly';
                    document.getElementById('widget-test').className = 'test error';
                }
                
                if (window.BarmudaWidget) {
                    addLog('BarmudaWidget global object available', 'success');
                }
            }, 2000);
        };
        
        script.onerror = function() {
            addLog('Failed to load widget script from production', 'error');
            document.getElementById('widget-result').innerHTML = '‚ùå Could not load widget from production';
            document.getElementById('widget-test').className = 'test error';
        };
        
        document.head.appendChild(script);
        
        // Test API on load
        setTimeout(testAPI, 1000);
        
        addLog('Test page initialized');
    </script>
</body>
</html>